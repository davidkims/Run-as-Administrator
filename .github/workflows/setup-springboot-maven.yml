name: Setup SpringBoot and Maven Project (Safe Disk)

on:
  workflow_dispatch:
    inputs:
      free_disk_space:
        description: "ì—¬ìœ  ê³µê°„ í™•ë³´ ì‹¤í–‰ (Android/.NET/CodeQL/ë„ì»¤ìºì‹œ ì œê±°)"
        required: true
        default: "false"
      simulate_low_disk:
        description: "ì €ìš©ëŸ‰ ë””ìŠ¤í¬ ì‹œë®¬ë ˆì´ì…˜ (ë£¨í”„ë°± 2~4GB /mnt/lowdisk ë§ˆìš´íŠ¸)"
        required: true
        default: "false"

permissions:
  contents: write

jobs:
  setup:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ›’ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ“Š Show initial disk usage
        run: |
          set -Eeuo pipefail
          echo "== df -h =="
          df -h
          echo "== docker images (top 10) =="
          docker images | head -n 10 || true

      # ê³µê°„ì´ í•„ìš”í•  ë•Œë§Œ ì•ˆì „í•˜ê²Œ ì •ë¦¬ (Android/.NET/CodeQL/ë„ì»¤ ì´ë¯¸ì§€ ìºì‹œ ë“±)
      - name: ğŸ§¹ (Optional) Free up disk space
        if: ${{ github.event.inputs.free_disk_space == 'true' }}
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          codeql: true
          docker-images: true
          large-packages: false
          swap-storage: false
      # ì°¸ê³ : ìœ„ ì•¡ì…˜ì€ ëŸ¬ë„ˆ ì´ë¯¸ì§€ì˜ ì‚¬ì „ ì„¤ì¹˜ íˆ´ì„ ì œê±°í•˜ì—¬ ìˆ˜~ì‹­ GB í™•ë³´í•©ë‹ˆë‹¤. :contentReference[oaicite:1]{index=1}

      - name: ğŸ“Š Show disk after cleanup
        if: ${{ github.event.inputs.free_disk_space == 'true' }}
        run: df -h

      - name: ğŸ§± Create Project Directories and Dummy Files
        run: |
          set -Eeuo pipefail
          sudo mkdir -p /opt/project/springboot/{src,logs,temp,server}
          sudo mkdir -p /opt/project/maven/{src,target,logs}
          mkdir -p .github/workflows
          sudo mkdir -p /opt/disks/{springboot,maven}
          echo "Spring Boot Server Log" | sudo tee /opt/project/springboot/logs/server.log >/dev/null
          echo "Maven Project Placeholder" | sudo tee /opt/project/maven/src/Main.java >/dev/null
          echo "âœ… ë””ë ‰í† ë¦¬ ë° íŒŒì¼ ìƒì„± ì™„ë£Œ"

      # âŒ ì‚­ì œ: ì‹œìŠ¤í…œì„ ë§ê°€ëœ¨ë¦¬ëŠ” 100GB ì˜ˆì•½
      # âœ”ï¸ ëŒ€ì•ˆ1: ì €ìš©ëŸ‰ ë””ìŠ¤í¬ 'ì‹œë®¬ë ˆì´ì…˜'ì„ ì›í•  ë•Œë§Œ /mnt/lowdisk ì— ë£¨í”„ë°± ë§ˆìš´íŠ¸
      - name: ğŸ§ª (Optional) Simulate low-disk via loopback mount
        if: ${{ github.event.inputs.simulate_low_disk == 'true' }}
        id: lowdisk
        run: |
          set -Eeuo pipefail
          MNT="/mnt/lowdisk"
          IMG="/mnt/tmp-pv.img"
          sudo mkdir -p "$MNT"
          # ë‚¨ì€ ê³µê°„ì„ í™•ì¸í•˜ê³  2~4GB ì‚¬ì´ì—ì„œ ì•ˆì „í•˜ê²Œ íŒŒì¼ ìƒì„±
          AVAIL_GB=$(df --output=avail -BG /mnt | tail -1 | tr -dc '0-9')
          # ìµœì†Œ 6GBëŠ” ì‹œìŠ¤í…œì— ë‚¨ê¸°ê³ , ê·¸ ì•ˆì—ì„œ ìµœëŒ€ 4GB ì‚¬ìš©
          SIZE_GB=2
          if [ "$AVAIL_GB" -ge 12 ]; then SIZE_GB=4; fi
          echo "Creating loopback file of ${SIZE_GB}G at $IMG (Avail=${AVAIL_GB}G)"
          sudo fallocate -l ${SIZE_GB}G "$IMG" || sudo dd if=/dev/zero of="$IMG" bs=1M count=$((SIZE_GB*1024))
          sudo mkfs.ext4 -F "$IMG"
          sudo mount -o loop "$IMG" "$MNT"
          sudo chmod 777 "$MNT"
          echo "mounted" > "$MNT/.ok"
          echo "img=$IMG" >> $GITHUB_OUTPUT
          echo "mnt=$MNT" >> $GITHUB_OUTPUT
          df -h "$MNT"

      - name: â˜• Install Maven
        run: |
          set -Eeuo pipefail
          sudo apt-get update -y
          sudo apt-get install -y maven
          mvn -v

      - name: ğŸ§ª Test Maven Build Directory
        run: |
          set -Eeuo pipefail
          cd /opt/project/maven
          mvn -q archetype:generate \
            -DgroupId=com.example \
            -DartifactId=test-app \
            -DarchetypeArtifactId=maven-archetype-quickstart \
            -DinteractiveMode=false
          echo "âœ… Maven í”„ë¡œì íŠ¸ ìƒì„± ì™„ë£Œ"

      - name: ğŸš€ Simulate Spring Boot Server Setup
        run: |
          set -Eeuo pipefail
          echo "ğŸ› ï¸ Spring Boot ì„œë²„ ì„¤ì¹˜ ì¤‘..."
          sudo bash -c 'echo "Simulated Spring Boot JAR" > /opt/project/springboot/server/app.jar'
          ls -al /opt/project/springboot/server
          echo "âœ… Spring Boot ì„œë²„ ì„¤ì¹˜ ë° JAR ìƒì„± ì™„ë£Œ"

      - name: ğŸ“„ Summary Report
        run: |
          echo "ğŸ“„ ì‹¤í–‰ ì™„ë£Œ ìš”ì•½:"
          echo "- Spring Boot ê²½ë¡œ: /opt/project/springboot"
          echo "- Maven ê²½ë¡œ: /opt/project/maven"
          echo "- JAR íŒŒì¼: /opt/project/springboot/server/app.jar"
          if [[ "${{ steps.lowdisk.outcome || '' }}" == "success" ]]; then
            echo "- ì €ìš©ëŸ‰ ì‹œë®¬ë ˆì´ì…˜ ë§ˆìš´íŠ¸: ${{ steps.lowdisk.outputs.mnt }}"
          fi
          echo "== df -h =="
          df -h

      # í•­ìƒ ì •ë¦¬ (ì‹œë®¬ë ˆì´ì…˜ ë§ˆìš´íŠ¸/ì´ë¯¸ì§€ ì œê±°)
      - name: ğŸ§½ Post-cleanup
        if: always()
        run: |
          set -Eeuo pipefail
          if mountpoint -q "${{ steps.lowdisk.outputs.mnt }}"; then
            sudo umount "${{ steps.lowdisk.outputs.mnt }}"
          fi
          if [ -n "${{ steps.lowdisk.outputs.img }}" ] && [ -f "${{ steps.lowdisk.outputs.img }}" ]; then
            sudo rm -f "${{ steps.lowdisk.outputs.img }}"
          fi
          rm -f .github/workflows/.reserve_space || true
          echo "Cleanup done."
