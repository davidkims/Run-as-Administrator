name: "ğŸ§ª Test Server EchoOps (Build + Run + Restart + Kill Fallback)"

on:
  workflow_dispatch:
    inputs:
      project_dir:
        description: "í”„ë¡œì íŠ¸ ë£¨íŠ¸ (pom.xml ìœ„ì¹˜)"
        required: true
        default: "."
      app_port:
        description: "ì• í”Œë¦¬ì¼€ì´ì…˜ í¬íŠ¸"
        required: true
        default: "8080"
      main_class:
        description: "ë©”ì¸ í´ë˜ìŠ¤ (ì˜ˆ: com.example.demo.DemoApplication)"
        required: true
        default: "com.example.demo.DemoApplication"
      image_gen_enabled:
        description: "Vertex AI ì´ë¯¸ì§€ ìƒì„± ì»¨íŠ¸ë¡¤ëŸ¬ ì¶”ê°€/ë¹Œë“œ (true/false)"
        required: true
        default: "false"
      gcp_project_id:
        description: "GCP Project ID (image_gen_enabled=trueì¼ ë•Œ í•„ìš”)"
        required: false
        default: ""
      gcp_location:
        description: "Vertex AI Region (ì˜ˆ: us-central1)"
        required: false
        default: "us-central1"

permissions:
  contents: read

jobs:
  test-server:
    runs-on: ubuntu-latest
    env:
      APP_PORT: ${{ inputs.app_port }}
      PROJ_DIR: ${{ inputs.project_dir }}
      MAIN_CLASS: ${{ inputs.main_class }}
      IMAGE_GEN_ENABLED: ${{ inputs.image_gen_enabled }}
      GCP_PROJECT_ID: ${{ inputs.gcp_project_id }}
      GCP_LOCATION: ${{ inputs.gcp_location }}
      JAVA_DISTRIBUTION: temurin
      JAVA_VERSION: "17"
      ECHO_ROOT: .github/echo_test
      PID_FILE: .github/echo_test/app.pid
      LOG_FILE: .github/echo_test/app.log
      HEALTH_URL: http://127.0.0.1:${{ inputs.app_port }}/actuator/health
      STARTUP_WAIT: "3"

    steps:
      - name: "ğŸ“¥ Checkout"
        uses: actions/checkout@v4

      - name: "â˜• Setup Java + Maven Cache"
        uses: actions/setup-java@v4
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}
          cache: "maven"

      - name: "ğŸ§° EchoOps: helpers & folders"
        shell: bash
        run: |
          set -Eeuo pipefail
          mkdir -p "${ECHO_ROOT}"
          TS(){ date '+%Y-%m-%d %H:%M:%S'; }
          echoe(){ printf '[%s] [INFO] %s\n' "$(TS)" "$*"; }
          warn(){ printf '[%s] [WARN] %s\n' "$(TS)" "$*"; }
          fail(){ printf '[%s] [FAIL] %s\n' "$(TS)" "$*"; exit 1; }

          echoe "Runner: $(uname -a)"
          echoe "Repo: $GITHUB_REPOSITORY | SHA: $GITHUB_SHA"
          echoe "ProjectDir: ${PROJ_DIR}"
          echoe "MAIN_CLASS: ${MAIN_CLASS}"
          echoe "APP_PORT: ${APP_PORT}"

          # í‘œì¤€ Maven ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p "${PROJ_DIR}/src/main/java" \
                   "${PROJ_DIR}/src/main/resources" \
                   "${PROJ_DIR}/src/test/java" \
                   "${PROJ_DIR}/src/test/resources"

          # ë¡œê·¸/ìƒíƒœ íŒŒì¼ ì¤€ë¹„
          : > "${LOG_FILE}"
          echo $$ > "${ECHO_ROOT}/runner.pid"

      - name: "ğŸ§ª Sanity: pom.xml ì¡´ì¬ ì—¬ë¶€ í™•ì¸"
        shell: bash
        run: |
          set -Eeuo pipefail
          TS(){ date '+%Y-%m-%d %H:%M:%S'; }
          echoe(){ printf '[%s] [INFO] %s\n' "$(TS)" "$*"; }

          if [ ! -f "${PROJ_DIR}/pom.xml" ]; then
            echoe "pom.xmlì´ ì—†ìŠµë‹ˆë‹¤. ê°„ë‹¨í•œ Spring Boot POMì„ ìƒì„±í•©ë‹ˆë‹¤."
            cat > "${PROJ_DIR}/pom.xml" <<'POM'
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
  <modelVersion>4.0.0</modelVersion>
  <groupId>com.example</groupId>
  <artifactId>demo-app</artifactId>
  <version>0.0.1-SNAPSHOT</version>
  <name>demo-app</name>
  <properties>
    <java.version>17</java.version>
    <spring-boot.version>3.3.4</spring-boot.version>
  </properties>
  <dependencyManagement>
    <dependencies>
      <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-dependencies</artifactId>
        <version>${spring-boot.version}</version>
        <type>pom</type>
        <scope>import</scope>
      </dependency>
    </dependencies>
  </dependencyManagement>
  <dependencies>
    <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-actuator</artifactId>
    </dependency>
    <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-devtools</artifactId>
      <scope>runtime</scope>
      <optional>true</optional>
    </dependency>
    <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-test</artifactId>
      <scope>test</scope>
    </dependency>
  </dependencies>
  <build>
    <plugins>
      <plugin>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-maven-plugin</artifactId>
        <configuration>
          <jvmArguments>-Dserver.port=${env.APP_PORT}</jvmArguments>
        </configuration>
      </plugin>
    </plugins>
  </build>
</project>
POM
          fi

      - name: "ğŸ§© (ì˜µì…˜) Vertex AI ì´ë¯¸ì§€ ìƒì„± ì»¨íŠ¸ë¡¤ëŸ¬ & ì˜ì¡´ì„± ì£¼ì…"
        if: ${{ env.IMAGE_GEN_ENABLED == 'true' }}
        shell: bash
        run: |
          set -Eeuo pipefail
          TS(){ date '+%Y-%m-%d %H:%M:%S'; }
          echoe(){ printf '[%s] [INFO] %s\n' "$(TS)" "$*"; }
          fail(){ printf '[%s] [FAIL] %s\n' "$(TS)" "$*"; exit 1; }

          [ -n "${GCP_PROJECT_ID}" ] || fail "gcp_project_id ì…ë ¥ì´ í•„ìš”í•©ë‹ˆë‹¤."
          [ -n "${GCP_LOCATION}" ] || fail "gcp_location ì…ë ¥ì´ í•„ìš”í•©ë‹ˆë‹¤."

          # POMì— Google BOM/vertexai ì˜ì¡´ì„± ì¶”ê°€(ì¤‘ë³µ ë°©ì§€)
          if ! grep -q "google-cloud-vertexai" "${PROJ_DIR}/pom.xml"; then
            echoe "google-cloud-vertexai ì˜ì¡´ì„± ì¶”ê°€"
            awk '
              /<\/dependencyManagement>/ && !added_dm {
                print "    <dependencies>\n      <dependency>\n        <groupId>com.google.cloud</groupId>\n        <artifactId>libraries-bom</artifactId>\n        <version>26.32.0</version>\n        <type>pom</type>\n        <scope>import</scope>\n      </dependency>\n    </dependencies>";
                added_dm=1
              }
              { print }
            ' "${PROJ_DIR}/pom.xml" > "${PROJ_DIR}/pom.xml.tmp" && mv "${PROJ_DIR}/pom.xml.tmp" "${PROJ_DIR}/pom.xml"

            awk '
              /<\/dependencies>/ && !added_dep {
                print "    <dependency>\n      <groupId>com.google.cloud</groupId>\n      <artifactId>google-cloud-vertexai</artifactId>\n    </dependency>";
                added_dep=1
              }
              { print }
            ' "${PROJ_DIR}/pom.xml" > "${PROJ_DIR}/pom.xml.tmp" && mv "${PROJ_DIR}/pom.xml.tmp" "${PROJ_DIR}/pom.xml"
          else
            echoe "vertexai ì˜ì¡´ì„±ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤."
          fi

          # ì»¨íŠ¸ë¡¤ëŸ¬ ìƒì„±
          PKG_DIR="${PROJ_DIR}/src/main/java/com/example/demo"
          mkdir -p "${PKG_DIR}"
          cat > "${PKG_DIR}/ImageGenerationController.java" <<'JAVA'
package com.example.demo;

import com.google.cloud.vertexai.VertexAI;
import com.google.cloud.vertexai.api.GenerateContentResponse;
import com.google.cloud.vertexai.generativeai.GenerativeModel;
import com.google.cloud.vertexai.generativeai.ResponseHandler;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.io.IOException;
import java.util.Base64;

@RestController
public class ImageGenerationController {

    @GetMapping(value = "/generate-image", produces = MediaType.IMAGE_PNG_VALUE)
    public ResponseEntity<byte[]> generateImage(
            @RequestParam(defaultValue = "A painting of a cat sitting on a windowsill looking at the moon")
            String prompt) throws IOException {

        String projectId = System.getenv("GOOGLE_CLOUD_PROJECT_ID");
        String location  = System.getenv("GOOGLE_CLOUD_LOCATION");
        if (projectId == null || projectId.isBlank()) {
            projectId = "${GCP_PROJECT_ID}";
        }
        if (location == null || location.isBlank()) {
            location = "${GCP_LOCATION}";
        }
        String modelName = "imagegeneration@006";

        try (VertexAI vertexAI = new VertexAI(projectId, location)) {
            GenerativeModel model = new GenerativeModel(modelName, vertexAI);
            GenerateContentResponse response = model.generateContent(prompt);

            // ì´ë¯¸ì§€ íŒŒíŠ¸(Base64 ì¸ë¼ì¸ ë°ì´í„°) ì¶”ì¶œ
            String b64 = ResponseHandler.getContent(response)
                                        .getParts(0)
                                        .getInlineData()
                                        .getData()
                                        .toStringUtf8();

            byte[] imageBytes = Base64.getDecoder().decode(b64);
            return ResponseEntity.ok()
                    .contentType(MediaType.IMAGE_PNG)
                    .body(imageBytes);
        }
    }
}
JAVA

          echoe "ì»¨íŠ¸ë¡¤ëŸ¬ ìƒì„± ì™„ë£Œ: ${PKG_DIR}/ImageGenerationController.java"
          echoe "ì£¼ì˜: GCP ì¸ì¦ì€ ëŸ°íƒ€ì„ í™˜ê²½ë³€ìˆ˜/ìê²© í•„ìš”(GOOGLE_APPLICATION_CREDENTIALS ë“±)"

      - name: "ğŸ§± Build (mvn clean package -DskipTests)"
        shell: bash
        working-directory: ${{ env.PROJ_DIR }}
        run: |
          set -Eeuo pipefail
          TS(){ date '+%Y-%m-%d %H:%M:%S'; }
          echoe(){ printf '[%s] [INFO] %s\n' "$(TS)" "$*"; }

          echoe "Maven Build ì‹œì‘"
          mvn -B -ntp -DskipTests clean package
          echoe "JAR ì‚°ì¶œë¬¼ í™•ì¸"
          ls -l target/*.jar || (echo "JAR ë¯¸ìƒì„±" && exit 1)

      - name: "ğŸš€ Start app (background) & write PID"
        shell: bash
        working-directory: ${{ env.PROJ_DIR }}
        run: |
          set -Eeuo pipefail
          TS(){ date '+%Y-%m-%d %H:%M:%S'; }
          echoe(){ printf '[%s] [INFO] %s\n' "$(TS)" "$*"; }
          warn(){ printf '[%s] [WARN] %s\n' "$(TS)" "$*"; }

          JAR="$(ls target/*.jar | head -n1)"
          echoe "ì‹¤í–‰ JAR: $JAR"
          # ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬
          if [ -f "${PID_FILE}" ] && ps -p "$(cat ${PID_FILE})" > /dev/null 2>&1; then
            warn "ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ê°ì§€ â†’ ì¢…ë£Œ ì‹œë„"
            kill "$(cat ${PID_FILE})" || true
            sleep 2
          fi

          # ì‹¤í–‰
          nohup java -jar "$JAR" --server.port="${APP_PORT}" > "${LOG_FILE}" 2>&1 &
          NEW_PID=$!
          echo "${NEW_PID}" > "${PID_FILE}"
          echoe "ì‹¤í–‰ PID: ${NEW_PID} | ë¡œê·¸: ${LOG_FILE}"

          # 1ì°¨ ëŒ€ê¸°
          sleep "${STARTUP_WAIT}"

      - name: "ğŸ©º Health Check (actuator ìš°ì„ , ì‹¤íŒ¨ ì‹œ ë£¨íŠ¸)"
        shell: bash
        run: |
          set +e
          TS(){ date '+%Y-%m-%d %H:%M:%S'; }
          echoe(){ printf '[%s] [INFO] %s\n' "$(TS)" "$*"; }
          warn(){ printf '[%s] [WARN] %s\n' "$(TS)" "$*"; }

          HEALTH_OK=0
          if curl -fsS "${HEALTH_URL}" | grep -q '"status":"UP"'; then
            echoe "Actuator OK"
            HEALTH_OK=1
          else
            warn "Actuator ì‹¤íŒ¨, ë£¨íŠ¸(/) ì‹œë„"
            curl -fsS "http://127.0.0.1:${APP_PORT}/" >/dev/null && HEALTH_OK=1 || true
          fi

          if [ "${HEALTH_OK}" -eq 1 ]; then
            echoe "ì• í”Œë¦¬ì¼€ì´ì…˜ ê°€ë™ ì •ìƒ"
            exit 0
          else
            echoe "ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹„ì •ìƒ â†’ ì¬ê¸°ë™ ë£¨í‹´ ì§„ì…"
            exit 1
          fi

      - name: "ğŸ” ì¬ê¸°ë™ ë£¨í‹´: stop â†’ start â†’ sleep 3 â†’ (ì—¬ì „íˆ ë¹„ì •ìƒ ì‹œ) kill"
        if: failure()   # ë°”ë¡œ ì• Health Check ì‹¤íŒ¨ ì‹œ ì‹¤í–‰
        shell: bash
        working-directory: ${{ env.PROJ_DIR }}
        run: |
          set -Eeuo pipefail
          TS(){ date '+%Y-%m-%d %H:%M:%S'; }
          echoe(){ printf '[%s] [INFO] %s\n' "$(TS)" "$*"; }
          warn(){ printf '[%s] [WARN] %s\n' "$(TS)" "$*"; }

          stop_if_running(){
            if [ -f "${PID_FILE}" ]; then
              OLD_PID="$(cat ${PID_FILE})"
              if ps -p "${OLD_PID}" > /dev/null 2>&1; then
                echoe "ê¸°ì¡´ PID ${OLD_PID} ì¢…ë£Œ"
                kill "${OLD_PID}" || true
                sleep 2
              fi
            fi
          }

          start_app(){
            JAR="$(ls target/*.jar | head -n1)"
            echoe "ì¬ê¸°ë™: $JAR"
            nohup java -jar "$JAR" --server.port="${APP_PORT}" > "${LOG_FILE}" 2>&1 &
            echo $! > "${PID_FILE}"
            echoe "ì¬ê¸°ë™ PID: $(cat ${PID_FILE})"
          }

          # 1) stop
          stop_if_running

          # 2) start
          start_app

          # 3) sleep 3
          sleep 3

          # 4) ê±´ê°• ì¬í™•ì¸ (ì‹¤íŒ¨ ì‹œ kill)
          if curl -fsS "${HEALTH_URL}" | grep -q '"status":"UP"'; then
            echoe "ì¬ê¸°ë™ í›„ Actuator OK"
            exit 0
          else
            warn "ì¬ê¸°ë™ í›„ì—ë„ ë¹„ì •ìƒ â†’ ê°•ì œ ì¢…ë£Œ"
            if [ -f "${PID_FILE}" ]; then
              KPID="$(cat ${PID_FILE})"
              kill -9 "${KPID}" || true
              echoe "kill -9 ${KPID} ìˆ˜í–‰"
            fi
            exit 1
          fi

      - name: "ğŸ§¾ Log & Artifact"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-server-logs-and-jar
          path: |
            ${{ env.LOG_FILE }}
            ${{ env.PROJ_DIR }}/target/*.jar
            ${{ env.PID_FILE }}
          if-no-files-found: "warn"
