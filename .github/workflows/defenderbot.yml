name: "ğŸ¦ FinOps + EchoOps: Docker Install/Upgrade + TD-Sim + ì¬ë¬´ì œí‘œ ì‹œë®¬ + ì´ë¯¸ì§€"

on:
  workflow_dispatch:
    inputs:
      rows:
        description: "ì‹œë®¬ë ˆì´ì…˜ ê±°ë˜ ê±´ìˆ˜(ì˜ˆ: 1000)"
        required: true
        default: "1000"
      commit_changes:
        description: "ì—ì½” ì‚°ì¶œë¬¼ ì»¤ë°‹/í‘¸ì‹œ (true/false)"
        required: true
        default: "true"
      create_release:
        description: "GitHub Release ìƒì„± (true/false)"
        required: true
        default: "false"
      enable_teradata:
        description: "Teradata ì»¨í…Œì´ë„ˆ ì‹œë„ (true/false) - í† í°/ë¼ì´ì„ ìŠ¤ í•„ìš”"
        required: true
        default: "false"
      run_kafka:
        description: "Kafka/ZooKeeper ì‹¤í–‰ (true/false)"
        required: true
        default: "false"
      teradata_token:
        description: "Teradata Docker í† í°(ì„ íƒ) - enable_teradata=trueì¼ ë•Œ ê¶Œì¥"
        required: false
        default: ""

permissions:
  contents: write
  packages: read

concurrency:
  group: finops-echoops-${{ github.ref }}
  cancel-in-progress: false

jobs:
  finops:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Echo helpers + Directories
        shell: bash
        run: |
          set -Eeuo pipefail
          TS(){ date +"%Y-%m-%d %H:%M:%S%z"; }
          echoe(){ echo "[$(TS)] [ECHO] $*"; }
          warn(){ echo "[$(TS)] [WARN] $*" >&2; }
          fail(){ echo "[$(TS)] [FAIL] $*" >&2; exit 1; }

          echoe "ëŒ€ëŸ‰ ë””ë ‰í† ë¦¬ ìƒì„±"
          mkdir -p .github/echo/{logs,sql,bin,configs,imgs,reports} \
                   .github/echo_db/{ddl,dml,seed} \
                   .github/echo_td/{sim,docs} \
                   site/{reports,imgs,logs,sql} \
                   artifacts

          echoe "ì—ì½” ìƒíƒœ íŒŒì¼ ìƒì„±"
          printf "%s\n" "started: $(TS)" "actor: $GITHUB_ACTOR" "rows: ${{ inputs.rows }}" > .github/echo/logs/run.meta

      - name: Install/Upgrade Docker (with fallback)
        shell: bash
        run: |
          set -Eeuo pipefail
          TS(){ date +"%Y-%m-%d %H:%M:%S%z"; }
          echoe(){ echo "[$(TS)] [ECHO] $*"; }

          echoe "Docker ë²„ì „ í™•ì¸(ì‚¬ì „)"
          docker --version || true

          echoe "APT ì—…ë°ì´íŠ¸ ë° í•„ìˆ˜ íŒ¨í‚¤ì§€"
          sudo apt-get update -y
          sudo apt-get install -y apt-transport-https ca-certificates curl gnupg lsb-release jq

          echoe "Docker ê³µì‹ GPG í‚¤ ë° ë ˆí¬ì§€í† ë¦¬"
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --yes --dearmor -o /usr/share/keyrings/docker.gpg
          echo \
            "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
            $(. /etc/os-release && echo $VERSION_CODENAME) stable" | \
            sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

          echoe "Docker ìµœì‹  ì„¤ì¹˜/ì—…ê·¸ë ˆì´ë“œ"
          sudo apt-get update -y
          sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

          echoe "Docker ë²„ì „ í™•ì¸(ì„¤ì¹˜ í›„)"
          docker --version
          docker compose version || true

          echoe "í˜„ì¬ ì‚¬ìš©ì ë„ì»¤ ê·¸ë£¹ ì¶”ê°€(ì„¸ì…˜ ë°˜ì˜ì€ ë‹¤ìŒ ëŸ°ì— ì ìš©ë  ìˆ˜ ìˆìŒ)"
          sudo usermod -aG docker $USER || true

      - name: Start Core Containers (PostgreSQL + MinIO + Adminer)
        shell: bash
        run: |
          set -Eeuo pipefail
          TS(){ date +"%Y-%m-%d %H:%M:%S%z"; }
          echoe(){ echo "[$(TS)] [ECHO] $*"; }
          NET="finops_net"

          echoe "ë„ì»¤ ë„¤íŠ¸ì›Œí¬ ìƒì„±"
          docker network inspect "$NET" >/dev/null 2>&1 || docker network create "$NET"

          echoe "PostgreSQL ê¸°ë™(finops-db)"
          docker rm -f finops-db >/dev/null 2>&1 || true
          docker run -d --name finops-db --network "$NET" \
            -e POSTGRES_PASSWORD=finops \
            -e POSTGRES_USER=finops \
            -e POSTGRES_DB=finops \
            -p 5432:5432 \
            postgres:16

          echoe "Adminer ê¸°ë™(DB UI)"
          docker rm -f finops-adminer >/dev/null 2>&1 || true
          docker run -d --name finops-adminer --network "$NET" \
            -e ADMINER_DEFAULT_SERVER=finops-db \
            -p 8080:8080 \
            adminer:4

          echoe "MinIO ê¸°ë™(object storage)"
          docker rm -f finops-minio >/dev/null 2>&1 || true
          docker run -d --name finops-minio --network "$NET" \
            -e MINIO_ROOT_USER=admin -e MINIO_ROOT_PASSWORD=admin12345 \
            -p 9000:9000 -p 9001:9001 \
            minio/minio server /data --console-address ":9001"

          echoe "ì»¨í…Œì´ë„ˆ ìƒíƒœ"
          docker ps --format 'table {{.Names}}\t{{.Image}}\t{{.Status}}'

      - name: (Optional) Kafka + ZooKeeper
        if: ${{ inputs.run_kafka == 'true' }}
        shell: bash
        run: |
          set -Eeuo pipefail
          TS(){ date +"%Y-%m-%d %H:%M:%S%z"; }
          echoe(){ echo "[$(TS)] [ECHO] $*"; }
          NET="finops_net"

          echoe "ZooKeeper"
          docker rm -f finops-zk >/dev/null 2>&1 || true
          docker run -d --name finops-zk --network "$NET" -p 2181:2181 \
            -e ALLOW_ANONYMOUS_LOGIN=yes bitnami/zookeeper:3.9

          echoe "Kafka"
          docker rm -f finops-kafka >/dev/null 2>&1 || true
          docker run -d --name finops-kafka --network "$NET" -p 9092:9092 \
            -e KAFKA_BROKER_ID=1 \
            -e KAFKA_CFG_ZOOKEEPER_CONNECT=finops-zk:2181 \
            -e ALLOW_PLAINTEXT_LISTENER=yes \
            -e KAFKA_CFG_LISTENERS=PLAINTEXT://:9092 \
            -e KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://localhost:9092 \
            bitnami/kafka:3.7

          docker ps --format 'table {{.Names}}\t{{.Image}}\t{{.Status}}'

      - name: (Optional) Teradata Container Attempt (skips if not permitted)
        if: ${{ inputs.enable_teradata == 'true' }}
        shell: bash
        env:
          TD_TOKEN: ${{ inputs.teradata_token }}
        run: |
          set -Eeuo pipefail
          TS(){ date +"%Y-%m-%d %H:%M:%S%z"; }
          echoe(){ echo "[$(TS)] [ECHO] $*"; }
          warn(){ echo "[$(TS)] [WARN] $*" >&2; }

          echoe "Teradata ì»¨í…Œì´ë„ˆëŠ” ë¼ì´ì„ ìŠ¤/í† í°/ë™ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤."
          if [ -z "${TD_TOKEN:-}" ]; then
            warn "teradata_token ë¯¸ì œê³µ: ê³µì‹ ì´ë¯¸ì§€ í’€/ì‹¤í–‰ì„ ê±´ë„ˆëœë‹ˆë‹¤. TD-Sim(PostgreSQL)ë¡œ ëŒ€ì²´í•©ë‹ˆë‹¤."
            exit 0
          fi

          # ì‹¤ì œ Teradata ì´ë¯¸ì§€ëŠ” ê³µê°œì ìœ¼ë¡œ ì ‘ê·¼ ë¶ˆê°€(ê¶Œí•œ/ê³„ì•½ í•„ìš”). ì•„ë˜ëŠ” ìë¦¬í‘œì‹œì ì˜ˆì‹œì…ë‹ˆë‹¤.
          # ì‚¬ìš©ìëŠ” Teradataì—ì„œ ì œê³µí•˜ëŠ” ë ˆì§€ìŠ¤íŠ¸ë¦¬/í† í°/ì´ë¯¸ì§€ëª…ì„ ë¬¸ì„œì— ë”°ë¼ êµì²´í•˜ì„¸ìš”.
          warn "ë‹¤ìŒì€ ìƒ˜í”Œ ëª…ë ¹ì–´ í…œí”Œë¦¿ì…ë‹ˆë‹¤(ì‹¤í–‰ ì‹œ ì‹¤íŒ¨ ê°€ëŠ¥):"
          echo "docker login <teradata-registry> -u token -p ${TD_TOKEN}" | tee .github/echo/logs/teradata.login.txt
          echo "docker pull <teradata-registry>/teradata:latest" | tee -a .github/echo/logs/teradata.login.txt
          echo "docker run -d --name teradata --network finops_net <teradata-registry>/teradata:latest" | tee -a .github/echo/logs/teradata.login.txt

      - name: Generate DDL (Balance Sheet / Income Statement / Journal / Accounts)
        shell: bash
        run: |
          set -Eeuo pipefail
          echo '# DDL' > .github/echo_db/ddl/README.md

          cat > .github/echo_db/ddl/001_core.sql <<'SQL'
          create table if not exists accounts (
              account_id      bigserial primary key,
              account_no      varchar(32) unique not null,
              holder_name     varchar(128) not null,
              opened_at       timestamptz not null default now(),
              status          varchar(16) not null default 'ACTIVE'
          );
          create table if not exists journal_entries (
              je_id           bigserial primary key,
              ts              timestamptz not null default now(),
              account_no      varchar(32) not null,
              type            varchar(8) not null check (type in ('DEBIT','CREDIT')),
              amount          numeric(18,2) not null check (amount>=0),
              currency        varchar(8) not null default 'KRW',
              memo            text
          );
          create index if not exists ix_journal_account_ts on journal_entries(account_no, ts);

          create table if not exists transactions (
              txn_id          bigserial primary key,
              ts              timestamptz not null default now(),
              account_no      varchar(32) not null,
              direction       varchar(8) not null check (direction in ('IN','OUT')),
              amount          numeric(18,2) not null check (amount>=0),
              balance_after   numeric(18,2) not null,
              ref             varchar(64),
              note            text
          );
          create index if not exists ix_txn_account_ts on transactions(account_no, ts);

          create table if not exists balances (
              account_no      varchar(32) primary key,
              balance         numeric(18,2) not null default 0
          );

          -- ì¬ë¬´ì œí‘œ ì§‘ê³„ìš© ë·°(ê°„ë‹¨ ëª¨ë¸)
          create or replace view v_income_statement as
          select
             date_trunc('day', ts) as d,
             sum(case when direction='IN'  then amount else 0 end) as revenue,
             sum(case when direction='OUT' then amount else 0 end) as expense,
             sum(case when direction='IN'  then amount else -amount end) as profit
          from transactions
          group by 1
          order by 1;

          create or replace view v_balance_sheet as
          select
             sum(balance) as total_assets
          from balances;
          SQL

      - name: Apply DDL to PostgreSQL
        shell: bash
        run: |
          set -Eeuo pipefail
          PGPASSWORD=finops psql -h 127.0.0.1 -U finops -d finops -f .github/echo_db/ddl/001_core.sql

      - name: Seed virtual accounts
        shell: bash
        run: |
          set -Eeuo pipefail
          cat > .github/echo_db/seed/accounts.sql <<'SQL'
          do $$
          declare
            i int;
          begin
            for i in 1..50 loop
              insert into accounts(account_no, holder_name)
              values ( 'V' || to_char(i, 'FM000000'), 'User ' || i )
              on conflict (account_no) do nothing;
              insert into balances(account_no, balance) values ('V' || to_char(i,'FM000000'), 0)
              on conflict (account_no) do nothing;
            end loop;
          end$$;
          SQL
          PGPASSWORD=finops psql -h 127.0.0.1 -U finops -d finops -f .github/echo_db/seed/accounts.sql

      - name: Generate simulation script (Python)
        shell: bash
        run: |
          set -Eeuo pipefail
          cat > .github/echo/bin/simulate.py <<'PY'
          import os, random, csv, math, time
          from datetime import datetime, timedelta
          import psycopg2
          import matplotlib.pyplot as plt

          ROWS = int(os.getenv("ROWS", "1000"))
          PGHOST=os.getenv("PGHOST","127.0.0.1")
          PGUSER=os.getenv("PGUSER","finops")
          PGPASSWORD=os.getenv("PGPASSWORD","finops")
          PGDB=os.getenv("PGDB","finops")

          # ê³„ì¢Œ í’€
          accts = [f"V{str(i).zfill(6)}" for i in range(1,51)]

          conn = psycopg2.connect(host=PGHOST, user=PGUSER, password=PGPASSWORD, dbname=PGDB)
          cur = conn.cursor()

          # ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘ ì‹œê° (ê³¼ê±° 7ì¼ ë¶„ì‚°)
          base = datetime.utcnow() - timedelta(days=7)

          # ê±°ë˜ ìƒì„±
          rows = []
          for i in range(ROWS):
            acc = random.choice(accts)
            ts = base + timedelta(seconds=i* (7*24*3600/ROWS))
            direction = random.choice(["IN","OUT"])
            amount = round(random.uniform(10, 500000), 2)

            # ì”ì•¡ ì¡°íšŒ
            cur.execute("select balance from balances where account_no=%s", (acc,))
            bal = cur.fetchone()
            bal = float(bal[0]) if bal else 0.0
            new_bal = bal + amount if direction == "IN" else max(0.0, bal - amount)

            # íŠ¸ëœì­ì…˜ ê¸°ë¡
            cur.execute("""insert into transactions(account_no, direction, amount, balance_after, ref, note, ts)
                           values(%s,%s,%s,%s,%s,%s,%s) returning txn_id""",
                        (acc, direction, amount, new_bal, f"REF{i}", "sim", ts))
            # ì €ë„(ê°„ì†Œ)
            jtype = "DEBIT" if direction=="IN" else "CREDIT"
            cur.execute("""insert into journal_entries(account_no, type, amount, ts, memo)
                           values(%s,%s,%s,%s,%s)""", (acc, jtype, amount, ts, "sim"))

            # ì”ì•¡ ê°±ì‹ 
            cur.execute("""insert into balances(account_no, balance)
                           values(%s,%s) on conflict (account_no) do update set balance=excluded.balance""",
                        (acc, new_bal))
            rows.append((ts, acc, direction, amount, new_bal))

            if i % 200 == 0:
              conn.commit()
          conn.commit()

          # CSV ì €ì¥
          os.makedirs("site/reports", exist_ok=True)
          with open("site/reports/transactions.csv","w",newline="",encoding="utf-8") as f:
            w=csv.writer(f)
            w.writerow(["ts","account_no","direction","amount","balance_after"])
            w.writerows(rows)

          # ì´ë¯¸ì§€(ì¬ë¬´ì œí‘œ ìš”ì•½ ì°¨íŠ¸) ìƒì„±
          # ìˆ˜ìµ/ë¹„ìš©/ì´ìµ ë¼ì¸ ì°¨íŠ¸
          cur.execute("select d,revenue,expense,profit from v_income_statement order by d;")
          data = cur.fetchall()
          d = [r[0] for r in data]
          rev = [float(r[1]) for r in data]
          exp = [float(r[2]) for r in data]
          prof= [float(r[3]) for r in data]

          plt.figure()
          plt.plot(d, rev, label="Revenue")
          plt.plot(d, exp, label="Expense")
          plt.plot(d, prof, label="Profit")
          plt.legend()
          plt.title("Income Statement (Daily)")
          plt.xlabel("Date"); plt.ylabel("Amount")
          plt.tight_layout()
          plt.savefig("site/imgs/income_statement.png")

          # ìì‚° ì´ì•¡ ë§‰ëŒ€
          cur.execute("select total_assets from v_balance_sheet;")
          total_assets = float(cur.fetchone()[0] or 0)

          plt.figure()
          plt.bar(["Assets"], [total_assets])
          plt.title("Balance Sheet (Total Assets)")
          plt.tight_layout()
          plt.savefig("site/imgs/balance_sheet.png")

          cur.close(); conn.close()
          PY

          echo "psycopg2-binary" > .github/echo/requirements.txt
          echo "matplotlib" >> .github/echo/requirements.txt

      - name: Install Python deps & Run simulation
        shell: bash
        env:
          ROWS: ${{ inputs.rows }}
          PGHOST: 127.0.0.1
          PGUSER: finops
          PGPASSWORD: finops
          PGDB: finops
        run: |
          set -Eeuo pipefail
          python -m pip install --upgrade pip
          pip install -r .github/echo/requirements.txt
          python .github/echo/bin/simulate.py

      - name: Copy outputs to artifacts
        shell: bash
        run: |
          set -Eeuo pipefail
          cp -a .github/echo_db/ddl site/sql/
          cp -a .github/echo_db/seed site/sql/
          cp -a site/imgs artifacts/
          cp -a site/reports artifacts/
          cp -a site/sql artifacts/
          ls -R artifacts | tee .github/echo/logs/artifacts.tree

      - name: Commit & Push (optional)
        if: ${{ inputs.commit_changes == 'true' }}
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "[ECHO] FinOps+EchoOps outputs (images,csv,sql) rows=${{ inputs.rows }}"
          branch: ${{ github.ref_name }}

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: finops-echoops-artifacts
          path: |
            artifacts/**
            site/**
            .github/echo/**
          if-no-files-found: warn
          retention-days: 14

      - name: Create Release (optional)
        if: ${{ inputs.create_release == 'true' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: finops-echoops-${{ github.run_number }}
          name: "FinOps EchoOps Run #${{ github.run_number }}"
          draft: false
          prerelease: false
          files: |
            artifacts/**/*
