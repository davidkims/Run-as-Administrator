# .github/workflows/validate-workflows.yml
name: "âœ… Validate Workflow Syntax"

on:
  push:
    paths:
      - ".github/workflows/**"
  pull_request:
    paths:
      - ".github/workflows/**"

permissions:
  contents: read

jobs:
  validate-syntax:
    name: "Lint & Validate GitHub Workflows"
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      # 1) actionlint ì„¤ì¹˜ (ê³µì‹ ìŠ¤í¬ë¦½íŠ¸) + ì‹¤í–‰
      - name: ğŸ” Install actionlint
        shell: bash
        env:
          ACTIONLINT_VERSION: v1.7.1   # í•„ìš” ì‹œ ìµœì‹ ìœ¼ë¡œ ê³ ì • ê°±ì‹ 
        run: |
          set -Eeuo pipefail
          curl -sSfL https://raw.githubusercontent.com/rhysd/actionlint/main/scripts/download-actionlint.bash \
            | bash -s -- -b ./bin "${ACTIONLINT_VERSION}"
          ./bin/actionlint --version

      - name: â–¶ï¸ Run actionlint
        shell: bash
        run: |
          set -Eeuo pipefail
          # shellcheck ì—†ëŠ” í™˜ê²½ì—ì„œë„ ì§„í–‰ë˜ë„ë¡ ë¹„í™œì„±í™”
          ./bin/actionlint -color -shellcheck=

      # 2) yamllint (ì¼ë°˜ YAML ë¬¸ë²•/ìŠ¤íƒ€ì¼)
      - name: ğŸ§° Install yamllint
        run: |
          python3 -m pip install --upgrade pip
          pip install yamllint
      - name: ğŸ§ª Run yamllint
        run: |
          set -euo pipefail
          yamllint -s -f standard .github/workflows

      # 3) ì‹¬í™” ê²€ì‚¬: inputs 10ê°œ ì œí•œ, ì¤‘ë³µ í‚¤ íƒì§€, íŒŒì„œ ì´ì¤‘ ì²´í¬
      - name: ğŸ Deep Validate (PyYAML + ruamel.yaml)
        run: |
          set -euo pipefail
          python3 - <<'PY'
          import sys, glob, json
          from pathlib import Path
          import yaml
          from ruamel.yaml import YAML
          from ruamel.yaml.constructor import DuplicateKeyError

          files = sorted(glob.glob(".github/workflows/*.yml") + glob.glob(".github/workflows/*.yaml"))
          if not files:
            print("No workflow files found.")
            sys.exit(0)

          ru = YAML(typ='rt')
          errors, summary = [], []

          for f in files:
            p = Path(f)
            # ì¤‘ë³µ í‚¤ ê°ì§€
            try:
              with p.open(encoding="utf-8") as fh:
                ru.load(fh)
            except DuplicateKeyError as e:
              errors.append(f"[{f}] Duplicate key: {e}")
              continue
            except Exception as e:
              errors.append(f"[{f}] ruamel parse error: {e}")
              continue

            # PyYAML ë¡œë“œ
            try:
              with p.open(encoding="utf-8") as fh:
                data = yaml.safe_load(fh) or {}
            except Exception as e:
              errors.append(f"[{f}] PyYAML parse error: {e}")
              continue

            def count_inputs(kind):
              on = data.get("on") or {}
              sect = on.get(kind) or {}
              inputs = sect.get("inputs") or {}
              return len(inputs) if isinstance(inputs, dict) else 0

            wc = count_inputs("workflow_call")
            wd = count_inputs("workflow_dispatch")

            if wc > 10:
              errors.append(f"[{f}] workflow_call.inputs={wc} (>10) â€” GitHub limit exceeded.")
            if wd > 10:
              errors.append(f"[{f}] workflow_dispatch.inputs={wd} (>10) â€” GitHub limit exceeded.")

            summary.append({"file": f, "workflow_call_inputs": wc, "workflow_dispatch_inputs": wd})

          print("=== Inputs Summary ===")
          for row in summary:
            print(json.dumps(row, ensure_ascii=False))

          if errors:
            print("\n=== ERRORS ===")
            for e in errors:
              print(e)
            sys.exit(1)
          PY

      - name: âœ… Summary
        if: ${{ success() }}
        run: |
          echo "All .github/workflows passed:"
          echo "- actionlint (downloaded binary)"
          echo "- yamllint"
          echo "- deep checks (inputs <= 10, duplicate keys, parse)"
