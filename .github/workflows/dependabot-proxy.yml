name: "âœ… Validate Workflow Syntax (strict, guaranteed dump)"

on:
  push:
    paths: [".github/workflows/**", ".yamllint"]
  pull_request:
    paths: [".github/workflows/**", ".yamllint"]

permissions:
  contents: read

jobs:
  validate:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      LOG_DIR: ./.lint-dump
      BIN_DIR: ./bin
      ACTIONLINT_VERSION: "1.7.1"

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      # â”€â”€â”€â”€â”€ ëª¨ë“  ë‹¨ê³„ì—ì„œ ë¤í”„ ë””ë ‰í† ë¦¬ ë¯¸ë¦¬ ìƒì„± â”€â”€â”€â”€â”€
      - name: ğŸ“ Prepare dump/bin dirs
        shell: bash
        run: |
          set -Eeuo pipefail
          mkdir -p "$LOG_DIR" "$BIN_DIR"
          echo "Start lint run at $(date -u)" > "$LOG_DIR/README.txt"

      - name: ğŸ”§ Install actionlint
        shell: bash
        continue-on-error: true
        run: |
          mkdir -p "$LOG_DIR" "$BIN_DIR"
          echo "Installing actionlint..." >> "$LOG_DIR/README.txt"
          curl -sSfL https://raw.githubusercontent.com/rhysd/actionlint/main/scripts/download-actionlint.bash \
            -o /tmp/download-actionlint.bash
          bash /tmp/download-actionlint.bash "${ACTIONLINT_VERSION}" "$BIN_DIR" \
            >> "$LOG_DIR/actionlint-install.log" 2>&1 || true

      - name: ğŸ” Run actionlint
        shell: bash
        continue-on-error: true
        run: |
          mkdir -p "$LOG_DIR"
          if [ -x "$BIN_DIR/actionlint" ]; then
            "$BIN_DIR/actionlint" -color -shellcheck= \
              2>&1 | tee "$LOG_DIR/actionlint.log"
          else
            echo "actionlint missing" > "$LOG_DIR/actionlint.log"
          fi

      - name: ğŸ§° Install yamllint
        run: |
          python3 -m pip install --upgrade pip
          pip install yamllint

      - name: ğŸ§ª Run yamllint
        shell: bash
        continue-on-error: true
        run: |
          mkdir -p "$LOG_DIR"
          yamllint -f standard -s .github/workflows \
            2>&1 | tee "$LOG_DIR/yamllint.log" || true

      # â”€â”€â”€â”€â”€ í•­ìƒ ë¤í”„ ë””ë ‰í† ë¦¬ì— ìµœì†Œ 1ê°œ íŒŒì¼ ì¡´ì¬ ë³´ì¥ â”€â”€â”€â”€â”€
      - name: ğŸ§· Ensure dump presence
        if: ${{ always() }}
        shell: bash
        run: |
          mkdir -p "$LOG_DIR"
          if [ -z "$(ls -A "$LOG_DIR")" ]; then
            echo "Lint dump placeholder. Some steps produced no output." > "$LOG_DIR/README.txt"
          fi

      # â”€â”€â”€â”€â”€ ìˆ¨ê¹€ í´ë” ì—…ë¡œë“œ í—ˆìš© â”€â”€â”€â”€â”€
      - name: â¬†ï¸ Upload lint dump
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: workflow-lint-dump
          path: ./.lint-dump/**
          include-hidden-files: true     # â† ì¤‘ìš”!
          if-no-files-found: error       # â† ë°˜ë“œì‹œ ìƒì„±ë˜ê²Œ ê°•ì œ
          retention-days: 7
