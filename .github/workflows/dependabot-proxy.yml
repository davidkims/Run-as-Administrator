# íŒŒì¼ ê²½ë¡œ: .github/workflows/validate-workflows.yml
name: "âœ… Validate Workflow Syntax"

on:
  push:
    paths:
      - ".github/workflows/**"
  pull_request:
    paths:
      - ".github/workflows/**"

permissions:
  contents: read

jobs:
  validate-syntax:
    name: "Lint & Validate GitHub Workflows"
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      # 1) actionlint (GitHub Actions êµ¬ë¬¸/í‘œí˜„ì‹ ì „ìš© ë¦°í„°)
      - name: ğŸ” actionlint
        uses: rhysd/actionlint@v1
        with:
          # ì…¸ì²´ì»¤ ì„¤ì¹˜(ê°€ëŠ¥í•˜ë©´). ì‹¤íŒ¨í•´ë„ ë¦°íŠ¸ëŠ” ê³„ì† ì§„í–‰
          args: >
            -color
            -shellcheck=
        continue-on-error: false

      # 2) yamllint (ì¼ë°˜ YAML ë¬¸ë²•/ìŠ¤íƒ€ì¼)
      - name: ğŸ§° Install yamllint (pip)
        run: |
          python3 -m pip install --upgrade pip
          pip install yamllint
      - name: ğŸ§ª Run yamllint
        run: |
          set -euo pipefail
          # ê¸°ë³¸ ê·œì¹™ + ì¥í™©í•œ ì¶œë ¥, í•„ìš”í•˜ë©´ .yamllint ì¶”ê°€ ê°€ëŠ¥
          yamllint -s -f standard .github/workflows || (echo "yamllint failed" && exit 1)

      # 3) ì‹¬í™” ê²€ì‚¬: inputs 10ê°œ ì œí•œ, ì¤‘ë³µ í‚¤ íƒì§€, on: êµ¬ì¡° ì ê²€
      - name: ğŸ Deep Validate (PyYAML + ruamel.yaml)
        run: |
          set -euo pipefail

          python3 - <<'PY'
          import sys, os, glob, json
          from pathlib import Path

          # PyYAML ë¡œë“œ
          import yaml
          # ruamel.yamlë¡œ ì¤‘ë³µ í‚¤ ê°ì§€
          from ruamel.yaml import YAML
          from ruamel.yaml.constructor import DuplicateKeyError

          workflows = sorted(list(glob.glob(".github/workflows/*.yml")) + list(glob.glob(".github/workflows/*.yaml")))
          if not workflows:
            print("No workflow files found under .github/workflows/. Nothing to validate.")
            sys.exit(0)

          yaml_ruamel = YAML(typ='rt')  # round-trip for duplicate key detection

          errors = []
          summary = []

          for wf in workflows:
            p = Path(wf)
            # 3-1) ì¤‘ë³µ í‚¤ íƒì§€ (ruamel)
            try:
              with open(p, "r", encoding="utf-8") as f:
                yaml_ruamel.load(f)
            except DuplicateKeyError as e:
              errors.append(f"[{wf}] Duplicate key found: {e}")
              continue
            except Exception as e:
              errors.append(f"[{wf}] YAML parse error (ruamel): {e}")
              continue

            # 3-2) ì¼ë°˜ ë¡œë”©(PyYAML) í›„ êµ¬ì¡° ì ê²€
            try:
              with open(p, "r", encoding="utf-8") as f:
                data = yaml.safe_load(f) or {}
            except Exception as e:
              errors.append(f"[{wf}] YAML parse error (PyYAML): {e}")
              continue

            # on.workflow_call.inputs / on.workflow_dispatch.inputs ì˜ ê°œìˆ˜ í™•ì¸ (ê°ê° ìµœëŒ€ 10)
            def count_inputs(section_name):
              on = data.get("on") or {}
              sect = on.get(section_name) or {}
              inputs = sect.get("inputs") or {}
              if isinstance(inputs, dict):
                return len(inputs)
              return 0

            wc = count_inputs("workflow_call")
            wd = count_inputs("workflow_dispatch")

            if wc > 10:
              errors.append(f"[{wf}] workflow_call.inputs has {wc} (>10) â€” GitHub limit exceeded.")
            if wd > 10:
              errors.append(f"[{wf}] workflow_dispatch.inputs has {wd} (>10) â€” GitHub limit exceeded.")

            summary.append({
              "file": wf,
              "workflow_call_inputs": wc,
              "workflow_dispatch_inputs": wd,
            })

          # ê²°ê³¼ ì¶œë ¥
          print("=== Inputs Summary ===")
          for row in summary:
            print(json.dumps(row, ensure_ascii=False))

          if errors:
            print("\n=== ERRORS ===")
            for e in errors:
              print(e)
            sys.exit(1)
          PY

      # 4) ì‚¬ëŒ ì¹œí™”ì  ìš”ì•½ ì¶œë ¥ (ë¬¸ì œ ì—†ì„ ë•Œ)
      - name: âœ… Summary
        if: ${{ success() }}
        run: |
          echo "All workflow files under .github/workflows passed:"
          echo "- actionlint (GitHub Actions-aware lint)"
          echo "- yamllint (YAML syntax/style)"
          echo "- Deep checks (inputs <= 10, duplicate keys, structure)"
