# .github/workflows/validate-workflows.yml
name: "âœ… Validate Workflow Syntax (strict, guaranteed dump)"

on:
  push:
    paths: [".github/workflows/**", ".yamllint"]
  pull_request:
    paths: [".github/workflows/**", ".yamllint"]
  schedule:
    - cron: "0 18 * * *"   # ë§¤ì¼ KST 03:00 (UTC 18:00)
    - cron: "0 18 * * 6"   # ë§¤ì£¼ ì¼ìš”ì¼ KST 03:00 (UTC í† ìš”ì¼ 18:00)
  workflow_dispatch: {}

permissions:
  contents: read

concurrency:
  group: "validate-workflows-${{ github.ref }}"
  cancel-in-progress: true

jobs:
  validate:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      LOG_DIR: ./.lint-dump         # ìˆ¨ê¹€ ì›ë³¸
      STAGING_DIR: ./lint-dump      # ë¹„ìˆ¨ê¹€ ìŠ¤í…Œì´ì§•
      BIN_DIR: ./bin
      ACTIONLINT_VERSION: "1.7.1"   # ì¬í˜„ì„± ìœ„í•´ ê³ ì •(ì›í•˜ë©´ latest)

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      # â”€â”€ ë¤í”„ ë””ë ‰í† ë¦¬/ë°”ì´ë„ˆë¦¬ ê²½ë¡œ ì„ ë³´ì¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“ Prepare dump/bin dirs
        shell: bash
        run: |
          set -Eeuo pipefail
          mkdir -p "$LOG_DIR" "$BIN_DIR"
          echo "Start lint run at $(date -u)" > "$LOG_DIR/README.txt"
          {
            echo "Runner: $(uname -a)"
            echo "Kernel: $(uname -r)"
            echo "TS: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          } > "$LOG_DIR/env.txt"

      # â”€â”€ actionlint ì„¤ì¹˜ (ê³µì‹ ìŠ¤í¬ë¦½íŠ¸ â†’ tarball í´ë°±), ì‹¤íŒ¨í•´ë„ ì§„í–‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ”§ Install actionlint (script + fallback)
        shell: bash
        continue-on-error: true
        run: |
          set -Eeuo pipefail
          : > "$LOG_DIR/actionlint-install.log"
          curl -sSfL https://raw.githubusercontent.com/rhysd/actionlint/main/scripts/download-actionlint.bash \
            -o /tmp/download-actionlint.bash
          if bash /tmp/download-actionlint.bash "${ACTIONLINT_VERSION}" "$BIN_DIR" >>"$LOG_DIR/actionlint-install.log" 2>&1; then
            echo "[OK] actionlint installed via script" >> "$LOG_DIR/actionlint-install.log"
          else
            echo "[WARN] script failed; fallback to tarball" >> "$LOG_DIR/actionlint-install.log"
            V="${ACTIONLINT_VERSION}"; PV="v${ACTIONLINT_VERSION}"
            OS="linux"
            case "$(uname -m)" in x86_64) ARCH=amd64;; aarch64|arm64) ARCH=arm64;; *) ARCH=amd64;; esac
            TARBALL="actionlint_${V}_${OS}_${ARCH}.tar.gz"
            URL="https://github.com/rhysd/actionlint/releases/download/${PV}/${TARBALL}"
            curl -fL "$URL" -o "/tmp/${TARBALL}" >>"$LOG_DIR/actionlint-install.log" 2>&1 || true
            tar -xzf "/tmp/${TARBALL}" -C "$BIN_DIR" >>"$LOG_DIR/actionlint-install.log" 2>&1 || true
            chmod +x "$BIN_DIR/actionlint" || true
          fi
          if [ -x "$BIN_DIR/actionlint" ]; then
            "$BIN_DIR/actionlint" --version >> "$LOG_DIR/env.txt" 2>&1
          else
            echo "[FAIL] actionlint not installed" >> "$LOG_DIR/actionlint-install.log"
          fi

      - name: ğŸ” Run actionlint (STRICT)
        shell: bash
        continue-on-error: true
        run: |
          set -Eeuo pipefail
          if [ -x "$BIN_DIR/actionlint" ]; then
            "$BIN_DIR/actionlint" -color -shellcheck= 2>&1 | tee "$LOG_DIR/actionlint.log"
          else
            echo "[SKIP] actionlint binary missing" | tee "$LOG_DIR/actionlint.log"
          fi

      # â”€â”€ yamllint ì„¤ì¹˜ + ë ˆí¬ì— .yamllint ì—†ìœ¼ë©´ ì—„ê²© ê·œì¹™ ìë™ ìƒì„± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ§° Install yamllint
        continue-on-error: true
        run: |
          python3 -m pip install --upgrade pip
          pip install yamllint

      - name: ğŸ§· Ensure STRICT yamllint config (auto-create if absent)
        shell: bash
        continue-on-error: true
        run: |
          set -Eeuo pipefail
          cat > "$LOG_DIR/yamllint.strict.yml" <<'YAML'
          extends: default
          rules:
            document-start: {present: true}
            truthy:
              allowed-values: ['true', 'false']
              check-keys: true
            line-length:
              max: 80
              level: error
              allow-non-breakable-words: false
              allow-non-breakable-inline-mappings: false
          YAML

      - name: ğŸ§ª Run yamllint (STRICT)
        shell: bash
        continue-on-error: true
        run: |
          set -Eeuo pipefail
          if command -v yamllint >/dev/null 2>&1; then
            CONF=".yamllint"; [ -f ".yamllint" ] || CONF="$LOG_DIR/yamllint.strict.yml"
            echo "[INFO] using config: $CONF" | tee "$LOG_DIR/yamllint.cfg.txt"
            yamllint -c "$CONF" -f standard -s .github/workflows 2>&1 | tee "$LOG_DIR/yamllint.log"
          else
            echo "[SKIP] yamllint not installed" | tee "$LOG_DIR/yamllint.log"
          fi

      # â”€â”€ ì‹¬í™” ê²€ì‚¬: ì¤‘ë³µ í‚¤ + inputs â‰¤ 10 (ì‹¤íŒ¨í•´ë„ ì§„í–‰) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ Deep Validate (duplicate keys, inputs<=10)
        shell: bash
        continue-on-error: true
        run: |
          set -Eeuo pipefail
          python3 -m pip install -q ruamel.yaml pyyaml || true
          python3 - <<'PY' 2>&1 | tee "$LOG_DIR/deep-validate.log"
          import sys, glob, json
          from pathlib import Path
          import yaml
          from ruamel.yaml import YAML
          from ruamel.yaml.constructor import DuplicateKeyError

          files = sorted(glob.glob(".github/workflows/*.yml") + glob.glob(".github/workflows/*.yaml"))
          print("FILES:", files)
          if not files:
            print("No workflow files found."); sys.exit(0)

          ru = YAML(typ='rt')
          errors, summary = [], []
          for f in files:
            p = Path(f)
            try:
              with p.open(encoding="utf-8") as fh:
                ru.load(fh)
            except DuplicateKeyError as e:
              errors.append(f"[{f}] Duplicate key: {e}"); continue
            except Exception as e:
              errors.append(f"[{f}] ruamel parse error: {e}"); continue

            try:
              with p.open(encoding="utf-8") as fh:
                data = yaml.safe_load(fh) or {}
            except Exception as e:
              errors.append(f"[{f}] PyYAML parse error: {e}"); continue

            def count_inputs(kind):
              on = data.get("on") or {}
              sect = on.get(kind) or {}
              inputs = sect.get("inputs") or {}
              return len(inputs) if isinstance(inputs, dict) else 0

            wc = count_inputs("workflow_call")
            wd = count_inputs("workflow_dispatch")
            if wc > 10: errors.append(f"[{f}] workflow_call.inputs={wc} (>10)")
            if wd > 10: errors.append(f"[{f}] workflow_dispatch.inputs={wd} (>10)")

            summary.append({"file": f, "workflow_call_inputs": wc, "workflow_dispatch_inputs": wd})

          print("=== Inputs Summary ===")
          for row in summary:
            print(json.dumps(row, ensure_ascii=False))
          if errors:
            print("\n=== ERRORS ===")
            for e in errors: print(e)
            sys.exit(1)
          PY

      # â”€â”€ ë°˜ë“œì‹œ ë¬´ì–¸ê°€ ë‚¨ë„ë¡ ë³´ì¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ§· Ensure dump presence (always)
        if: ${{ always() }}
        shell: bash
        run: |
          mkdir -p "$LOG_DIR"
          [ -s "$LOG_DIR/README.txt" ] || echo "Lint dump placeholder." > "$LOG_DIR/README.txt"

      # â”€â”€ ìˆ¨ê¹€ í´ë” ì—…ë¡œë“œ ì´ìŠˆ íšŒí”¼: ìŠ¤í…Œì´ì§• â†’ ì—…ë¡œë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“¦ Stage dump to non-hidden dir (always)
        if: ${{ always() }}
        shell: bash
        run: |
          set -Eeuo pipefail
          rm -rf "$STAGING_DIR"
          mkdir -p "$STAGING_DIR"
          if [ -d "$LOG_DIR" ]; then
            cp -a "$LOG_DIR/." "$STAGING_DIR/" || true
          fi
          if [ -z "$(ls -A "$STAGING_DIR" 2>/dev/null)" ]; then
            echo "No logs produced." > "$STAGING_DIR/README.txt"
          fi
          ls -al "$STAGING_DIR" || true

      - name: â¬†ï¸ Upload lint dump (always)
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: workflow-lint-dump
          path: ./lint-dump/**
          if-no-files-found: error
          retention-days: 7
