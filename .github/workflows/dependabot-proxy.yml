name: "✅ Validate Workflow Syntax (strict, guaranteed dump)"

on:
  push:
    paths: [".github/workflows/**", ".yamllint"]
  pull_request:
    paths: [".github/workflows/**", ".yamllint"]

permissions:
  contents: read

jobs:
  validate:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      LOG_DIR: ./.lint-dump
      BIN_DIR: ./bin
      ACTIONLINT_VERSION: "1.7.1"

    steps:
      - name: 📥 Checkout
        uses: actions/checkout@v4

      # ───── 모든 단계에서 덤프 디렉토리 미리 생성 ─────
      - name: 📁 Prepare dump/bin dirs
        shell: bash
        run: |
          set -Eeuo pipefail
          mkdir -p "$LOG_DIR" "$BIN_DIR"
          echo "Start lint run at $(date -u)" > "$LOG_DIR/README.txt"

      - name: 🔧 Install actionlint
        shell: bash
        continue-on-error: true
        run: |
          mkdir -p "$LOG_DIR" "$BIN_DIR"
          echo "Installing actionlint..." >> "$LOG_DIR/README.txt"
          curl -sSfL https://raw.githubusercontent.com/rhysd/actionlint/main/scripts/download-actionlint.bash \
            -o /tmp/download-actionlint.bash
          bash /tmp/download-actionlint.bash "${ACTIONLINT_VERSION}" "$BIN_DIR" \
            >> "$LOG_DIR/actionlint-install.log" 2>&1 || true

      - name: 🔍 Run actionlint
        shell: bash
        continue-on-error: true
        run: |
          mkdir -p "$LOG_DIR"
          if [ -x "$BIN_DIR/actionlint" ]; then
            "$BIN_DIR/actionlint" -color -shellcheck= \
              2>&1 | tee "$LOG_DIR/actionlint.log"
          else
            echo "actionlint missing" > "$LOG_DIR/actionlint.log"
          fi

      - name: 🧰 Install yamllint
        run: |
          python3 -m pip install --upgrade pip
          pip install yamllint

      - name: 🧪 Run yamllint
        shell: bash
        continue-on-error: true
        run: |
          mkdir -p "$LOG_DIR"
          yamllint -f standard -s .github/workflows \
            2>&1 | tee "$LOG_DIR/yamllint.log" || true

      # ───── 항상 덤프 디렉토리에 최소 1개 파일 존재 보장 ─────
      - name: 🧷 Ensure dump presence
        if: ${{ always() }}
        shell: bash
        run: |
          mkdir -p "$LOG_DIR"
          if [ -z "$(ls -A "$LOG_DIR")" ]; then
            echo "Lint dump placeholder. Some steps produced no output." > "$LOG_DIR/README.txt"
          fi

      # ───── 숨김 폴더 업로드 허용 ─────
      - name: ⬆️ Upload lint dump
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: workflow-lint-dump
          path: ./.lint-dump/**
          include-hidden-files: true     # ← 중요!
          if-no-files-found: error       # ← 반드시 생성되게 강제
          retention-days: 7
