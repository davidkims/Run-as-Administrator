name: "ðŸ—„ï¸ Workflow DB FullOps (ê¶Œí•œ íŒŒì¼ ìƒì„±+ì ìš©+ì œí’ˆë³„ ìƒ˜í”Œ)"

on:
  workflow_dispatch:
    inputs:
      wf_product:
        description: "ì›Œí¬í”Œë¡œìš° ì œí’ˆ"
        type: choice
        required: true
        default: "airflow"
        options: ["airflow", "n8n", "ibm-baw", "sharepoint-wfm"]
      target_db:
        description: "ëŒ€ìƒ DB"
        type: choice
        required: true
        default: "postgres"
        options: ["postgres", "mysql", "mssql"]  # mssqlì€ ê¶Œí•œíŒŒì¼ë§Œ ìƒì„±(ê¸°ë³¸)
      db_name:
        description: "DB ì´ë¦„"
        required: true
        default: "appdb"
      db_user:
        description: "DB ì ‘ì† ì‚¬ìš©ìž"
        required: true
        default: "appuser"
      db_password:
        description: "DB ì ‘ì† ë¹„ë°€ë²ˆí˜¸"
        required: true
        default: "StrongPw123!"
      extra_schema:
        description: "ì¶”ê°€ ìŠ¤í‚¤ë§ˆ(ì—†ìœ¼ë©´ ë¹ˆì¹¸)"
        required: false
        default: ""
      grant_model:
        description: "ê¶Œí•œ ëª¨ë¸"
        type: choice
        required: true
        default: "strict"
        options: ["strict", "basic"]
      enable_tls:
        description: "TLS ê°€ì´ë“œ íŒŒì¼ í¬í•¨"
        type: choice
        required: true
        default: "true"
        options: ["true", "false"]
      create_artifacts:
        description: "ìƒì„± ì‚°ì¶œë¬¼(ê¶Œí•œ SQL/ìƒ˜í”Œì„¤ì •) ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ"
        type: choice
        required: true
        default: "true"
        options: ["true", "false"]
      run_apply:
        description: "DB ì»¨í…Œì´ë„ˆ ê¸°ë™ í›„ SQL ì‹¤ì œ ì ìš©(ì§€ì›: postgres/mysql)"
        type: choice
        required: true
        default: "false"
        options: ["true", "false"]

permissions:
  contents: write

jobs:
  db-fullops:
    runs-on: ubuntu-latest

    services:
      postgres:
        if: ${{ github.event.inputs.run_apply == 'true' && github.event.inputs.target_db == 'postgres' }}
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

      mysql:
        if: ${{ github.event.inputs.run_apply == 'true' && github.event.inputs.target_db == 'mysql' }}
        image: mysql:8
        env:
          MYSQL_ROOT_PASSWORD: root
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -proot --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

      # MSSQLì€ ì ìš© ë¹„í™œì„±(ê¶Œí•œ íŒŒì¼ë§Œ ìƒì„±). ì ìš© ì›í•˜ì‹œë©´ ì•„ëž˜ ì£¼ì„ í•´ì œ ë° ë‹¨ê³„ ì¶”ê°€ í•„ìš”.
      # mssql:
      #   if: ${{ github.event.inputs.run_apply == 'true' && github.event.inputs.target_db == 'mssql' }}
      #   image: mcr.microsoft.com/mssql/server:2022-latest
      #   env:
      #     ACCEPT_EULA: "Y"
      #     SA_PASSWORD: "Str0ng!Passw0rd"
      #   ports:
      #     - 1433:1433
      #   options: >-
      #     --health-cmd="/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P 'Str0ng!Passw0rd' -C -Q 'SELECT 1' || exit 1"
      #     --health-interval=15s
      #     --health-timeout=10s
      #     --health-retries=20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare variables
        id: prep
        shell: bash
        run: |
          set -Eeuo pipefail
          echo "WF_PRODUCT=${{ github.event.inputs.wf_product }}" >> $GITHUB_ENV
          echo "TARGET_DB=${{ github.event.inputs.target_db }}" >> $GITHUB_ENV
          echo "DB_NAME=${{ github.event.inputs.db_name }}" >> $GITHUB_ENV
          echo "DB_USER=${{ github.event.inputs.db_user }}" >> $GITHUB_ENV
          echo "DB_PASSWORD=${{ github.event.inputs.db_password }}" >> $GITHUB_ENV
          echo "EXTRA_SCHEMA=${{ github.event.inputs.extra_schema }}" >> $GITHUB_ENV
          echo "GRANT_MODEL=${{ github.event.inputs.grant_model }}" >> $GITHUB_ENV
          echo "ENABLE_TLS=${{ github.event.inputs.enable_tls }}" >> $GITHUB_ENV
          echo "CREATE_ARTIFACTS=${{ github.event.inputs.create_artifacts }}" >> $GITHUB_ENV
          echo "RUN_APPLY=${{ github.event.inputs.run_apply }}" >> $GITHUB_ENV
          mkdir -p .github/echo_db/{postgres,mysql,mssql,common} .github/echo_products/{airflow,n8n,ibm-baw,sharepoint-wfm}

      # 1) ê³µí†µ ë³´ì•ˆ/TLS ê°€ì´ë“œ & ë°±ì—…/DR ì²´í¬ë¦¬ìŠ¤íŠ¸
      - name: Generate common guides
        shell: bash
        run: |
          set -Eeuo pipefail
          cat > .github/echo_db/common/SECURITY_TLS_GUIDE.md <<'MD'
          # DB ë³´ì•ˆ/TLS ê°€ì´ë“œ (ìš”ì•½)
          - ì„œë²„ ì¸¡ TLS ì¸ì¦ì„œ, í´ë¼ì´ì–¸íŠ¸ ì¸ì¦(í•„ìš” ì‹œ) êµ¬ì„±
          - ìµœì†Œ ê¶Œí•œ ì›ì¹™(Role/Grant), ë¹„ë°€ë²ˆí˜¸ ê¸ˆê³ (Vault/KeyVault)
          - ê°ì‚¬ ë¡œê·¸ í™œì„±í™”, ë¡œí…Œì´ì…˜, ë³´ê´€ ì •ì±…
          - ë°±ì—…/DR: ì •ê¸° ë°±ì—… + ë³µêµ¬ ë¦¬í—ˆì„¤, PITR(Postgres) ë“±
          MD

          cat > .github/echo_db/common/BACKUP_DR_CHECKLIST.md <<'MD'
          # ë°±ì—…/DR ì²´í¬ë¦¬ìŠ¤íŠ¸
          - ì „ì²´/ì¦ë¶„ ë°±ì—… ì£¼ê¸°, ì ê²€ ì ˆì°¨
          - ë³µêµ¬ ëª©í‘œ(RPO/RTO) ì •ì˜ ë° ë¦¬í—ˆì„¤
          - ë ˆí”Œë¦¬ì¼€ì´ì…˜/HA êµ¬ì„±(AG/Patroni/InnoDB Cluster ë“±)
          - ìŠ¤ëƒ…ìƒ·/ì•„ì¹´ì´ë¸Œ ë³´ê´€ ê¸°ê°„ ë° ì ‘ê·¼í†µì œ
          MD

      # 2) ì œí’ˆë³„ ìƒ˜í”Œ ì„¤ì •/ê°€ì´ë“œ
      - name: Generate product samples
        shell: bash
        run: |
          set -Eeuo pipefail
          # Airflow
          cat > .github/echo_products/airflow/ENV.sample <<'ENV'
          AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=postgresql+psycopg2://airflow:pw@db:5432/airflow
          # airflow db init í›„ webserver/scheduler ì‹¤í–‰
          ENV

          # n8n
          cat > .github/echo_products/n8n/ENV.sample <<'ENV'
          DB_TYPE=postgresdb
          DB_POSTGRESDB_HOST=db
          DB_POSTGRESDB_PORT=5432
          DB_POSTGRESDB_DATABASE=n8n
          DB_POSTGRESDB_USER=n8n
          DB_POSTGRESDB_PASSWORD=strong_pw
          ENV

          # IBM BAW
          cat > .github/echo_products/ibm-baw/JDBC.sample.properties <<'PROPS'
          # ì˜ˆì‹œ JDBC (í™˜ê²½ì— ë§žê²Œ ìˆ˜ì •)
          db.type=postgres
          db.url=jdbc:postgresql://db.example.com:5432/bawdb?sslmode=require
          db.user=baw
          db.password=*****
          # BAWëŠ” Process/PDW/Common DB ë¶„ë¦¬(ë‹¨, PostgresëŠ” Common DB ì œì™¸ êµ¬ì„±)
          PROPS

          # SharePoint Workflow Manager
          cat > .github/echo_products/sharepoint-wfm/SETUP_CHECKLIST.md <<'MD'
          # SP Workflow Manager ì‚¬ì „ ì²´í¬
          - SQL Server: TCP/IP í™œì„±í™”(1433), SQL Browser ì‹¤í–‰
          - Azure Service Fabric Runtime ì„¤ì¹˜(ê¶Œìž¥ ìµœì‹ )
          - íŒœ êµ¬ì„± ê³„ì •/ê¶Œí•œ ì¤€ë¹„, ë°©í™”ë²½ ì˜ˆì™¸
          MD

      # 3) ê¶Œí•œ íŒŒì¼ â€” PostgreSQL
      - name: Generate PostgreSQL SQL (create/roles/grants)
        shell: bash
        run: |
          set -Eeuo pipefail
          cat > .github/echo_db/postgres/00_create_db.sql <<'SQL'
          DO $$
          BEGIN
            IF NOT EXISTS (SELECT FROM pg_database WHERE datname = :'DB_NAME') THEN
              PERFORM dblink_exec('dbname=postgres', 'CREATE DATABASE ' || quote_ident(:'DB_NAME'));
            END IF;
          END$$;
          SQL

          cat > .github/echo_db/postgres/01_roles.sql <<'SQL'
          -- ì‚¬ìš©ìž/ì—­í•  ìƒì„±
          CREATE ROLE :"DB_USER" LOGIN PASSWORD :'DB_PASSWORD';
          -- ìµœì†Œ ê¶Œí•œ ë¡¤(ì½ê¸°/ì“°ê¸°) ë¶„ë¦¬
          DO $$
          BEGIN
            IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname='app_read') THEN CREATE ROLE app_read NOLOGIN; END IF;
            IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname='app_write') THEN CREATE ROLE app_write NOLOGIN; END IF;
          END$$;
          GRANT app_read TO :"DB_USER";
          GRANT app_write TO :"DB_USER";
          SQL

          cat > .github/echo_db/postgres/02_schema_grants.sql <<'SQL'
          \connect :"DB_NAME";
          CREATE SCHEMA IF NOT EXISTS public AUTHORIZATION :"DB_USER";
          -- ì¶”ê°€ ìŠ¤í‚¤ë§ˆ(ì„ íƒ)
          -- CREATE SCHEMA IF NOT EXISTS :"EXTRA_SCHEMA" AUTHORIZATION :"DB_USER";
          ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT ON TABLES TO app_read;
          ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT,INSERT,UPDATE,DELETE ON TABLES TO app_write;
          SQL

          cat > .github/echo_db/postgres/03_model_strict.sql <<'SQL'
          -- strict ëª¨ë¸: í…Œì´ë¸”ë³„ ëª…ì‹œì  ê¶Œí•œë§Œ ë¶€ì—¬(ìƒ˜í”Œ)
          -- ì˜ˆì‹œ í…Œì´ë¸”
          CREATE TABLE IF NOT EXISTS public.process_instance(
            id BIGSERIAL PRIMARY KEY,
            status TEXT NOT NULL,
            assignee TEXT,
            created_at TIMESTAMPTZ DEFAULT now()
          );

          REVOKE ALL ON public.process_instance FROM PUBLIC;
          GRANT SELECT ON public.process_instance TO app_read;
          GRANT SELECT,INSERT,UPDATE,DELETE ON public.process_instance TO app_write;
          SQL

          cat > .github/echo_db/postgres/03_model_basic.sql <<'SQL'
          -- basic ëª¨ë¸: ìŠ¤í‚¤ë§ˆ ë‹¨ìœ„ë¡œ ì¼ê´„ ê¶Œí•œ
          ALTER SCHEMA public OWNER TO :"DB_USER";
          GRANT USAGE ON SCHEMA public TO app_read, app_write;
          GRANT SELECT ON ALL TABLES IN SCHEMA public TO app_read;
          GRANT SELECT,INSERT,UPDATE,DELETE ON ALL TABLES IN SCHEMA public TO app_write;
          SQL

      # 4) ê¶Œí•œ íŒŒì¼ â€” MySQL
      - name: Generate MySQL SQL (create/user/grants)
        shell: bash
        run: |
          set -Eeuo pipefail
          cat > .github/echo_db/mysql/00_create_db.sql <<'SQL'
          CREATE DATABASE IF NOT EXISTS `${DB_NAME}` CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;
          SQL

          cat > .github/echo_db/mysql/01_user.sql <<'SQL'
          CREATE USER IF NOT EXISTS '${DB_USER}'@'%' IDENTIFIED BY '${DB_PASSWORD}';
          GRANT USAGE ON *.* TO '${DB_USER}'@'%';
          SQL

          cat > .github/echo_db/mysql/02_grants_basic.sql <<'SQL'
          GRANT SELECT ON `${DB_NAME}`.* TO '${DB_USER}'@'%';
          GRANT INSERT, UPDATE, DELETE ON `${DB_NAME}`.* TO '${DB_USER}'@'%';
          FLUSH PRIVILEGES;
          SQL

          cat > .github/echo_db/mysql/02_grants_strict.sql <<'SQL'
          -- strict: í…Œì´ë¸” ìƒì„± í›„ í…Œì´ë¸” ë‹¨ìœ„ ë¶€ì—¬(ìƒ˜í”Œ)
          USE `${DB_NAME}`;
          CREATE TABLE IF NOT EXISTS process_instance(
            id BIGINT PRIMARY KEY AUTO_INCREMENT,
            status VARCHAR(64) NOT NULL,
            assignee VARCHAR(128),
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
          );
          REVOKE ALL PRIVILEGES, GRANT OPTION FROM '${DB_USER}'@'%';
          GRANT SELECT ON `${DB_NAME}`.process_instance TO '${DB_USER}'@'%';
          GRANT INSERT,UPDATE,DELETE ON `${DB_NAME}`.process_instance TO '${DB_USER}'@'%';
          FLUSH PRIVILEGES;
          SQL

      # 5) ê¶Œí•œ íŒŒì¼ â€” MSSQL (ìƒì„±ë§Œ)
      - name: Generate MSSQL SQL (create/login/grants) - files only
        shell: bash
        run: |
          set -Eeuo pipefail
          cat > .github/echo_db/mssql/00_create_db.sql <<'SQL'
          IF DB_ID(N'${DB_NAME}') IS NULL
            CREATE DATABASE [${DB_NAME}];
          GO
          SQL

          cat > .github/echo_db/mssql/01_user.sql <<'SQL'
          USE [${DB_NAME}];
          IF NOT EXISTS (SELECT 1 FROM sys.sql_logins WHERE name = N'${DB_USER}')
            CREATE LOGIN [${DB_USER}] WITH PASSWORD=N'${DB_PASSWORD}', CHECK_POLICY=ON;
          CREATE USER [${DB_USER}] FOR LOGIN [${DB_USER}];
          SQL

          cat > .github/echo_db/mssql/02_grants_basic.sql <<'SQL'
          USE [${DB_NAME}];
          EXEC sp_addrolemember N'db_datareader', N'${DB_USER}';
          EXEC sp_addrolemember N'db_datawriter', N'${DB_USER}';
          SQL

          cat > .github/echo_db/mssql/02_grants_strict.sql <<'SQL'
          USE [${DB_NAME}];
          IF OBJECT_ID('dbo.process_instance','U') IS NULL
            CREATE TABLE dbo.process_instance(
              id BIGINT IDENTITY(1,1) PRIMARY KEY,
              status NVARCHAR(64) NOT NULL,
              assignee NVARCHAR(128),
              created_at DATETIME2 DEFAULT SYSUTCDATETIME()
            );
          REVOKE SELECT, INSERT, UPDATE, DELETE ON dbo.process_instance FROM [${DB_USER}];
          GRANT SELECT ON dbo.process_instance TO [${DB_USER}];
          GRANT INSERT, UPDATE, DELETE ON dbo.process_instance TO [${DB_USER}];
          SQL

      # 6) ì‹¤ì œ ì ìš© (postgres/mysqlë§Œ)
      - name: Apply SQL (PostgreSQL)
        if: ${{ env.RUN_APPLY == 'true' && env.TARGET_DB == 'postgres' }}
        shell: bash
        run: |
          set -Eeuo pipefail
          sudo apt-get update && sudo apt-get install -y postgresql-client
          export PGPASSWORD=postgres
          psql -h localhost -U postgres -p 5432 -d postgres -v ON_ERROR_STOP=1 \
            -v DB_NAME="${DB_NAME}" -v DB_USER="${DB_USER}" -v DB_PASSWORD="${DB_PASSWORD}" -f .github/echo_db/postgres/00_create_db.sql

          # DB ë‚´ë¶€ ì ìš©
          psql -h localhost -U postgres -p 5432 -d "${DB_NAME}" -v ON_ERROR_STOP=1 \
            -v DB_NAME="${DB_NAME}" -v DB_USER="${DB_USER}" -v DB_PASSWORD="${DB_PASSWORD}" -f .github/echo_db/postgres/01_roles.sql

          psql -h localhost -U postgres -p 5432 -d "${DB_NAME}" -v ON_ERROR_STOP=1 \
            -v DB_NAME="${DB_NAME}" -v DB_USER="${DB_USER}" -v EXTRA_SCHEMA="${EXTRA_SCHEMA}" -f .github/echo_db/postgres/02_schema_grants.sql

          if [ "${GRANT_MODEL}" = "strict" ]; then
            psql -h localhost -U postgres -p 5432 -d "${DB_NAME}" -v ON_ERROR_STOP=1 -f .github/echo_db/postgres/03_model_strict.sql
          else
            psql -h localhost -U postgres -p 5432 -d "${DB_NAME}" -v ON_ERROR_STOP=1 -f .github/echo_db/postgres/03_model_basic.sql
          fi

      - name: Apply SQL (MySQL)
        if: ${{ env.RUN_APPLY == 'true' && env.TARGET_DB == 'mysql' }}
        shell: bash
        run: |
          set -Eeuo pipefail
          sudo apt-get update && sudo apt-get install -y mysql-client

          mysql -h 127.0.0.1 -P 3306 -uroot -proot < .github/echo_db/mysql/00_create_db.sql
          DBVARS=$(envsubst < .github/echo_db/mysql/01_user.sql)
          echo "$DBVARS" | mysql -h 127.0.0.1 -P 3306 -uroot -proot

          if [ "${GRANT_MODEL}" = "strict" ]; then
            DBVARS=$(envsubst < .github/echo_db/mysql/02_grants_strict.sql)
          else
            DBVARS=$(envsubst < .github/echo_db/mysql/02_grants_basic.sql)
          fi
          echo "$DBVARS" | mysql -h 127.0.0.1 -P 3306 -uroot -proot

      # 7) ì‚°ì¶œë¬¼ ì—…ë¡œë“œ
      - name: Upload artifacts
        if: ${{ env.CREATE_ARTIFACTS == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: db-fullops-artifacts
          path: |
            .github/echo_db/**
            .github/echo_products/**
