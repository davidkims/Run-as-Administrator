name: Test-Server + Spring Boot + Docker (Ultra Integrated - Hardened)

on:
  schedule:
    - cron: "*/10 * * * *"
  workflow_dispatch:
    inputs:
      freedisk_profile:
        description: "FreeDisk 프로파일 (none|minimal|aggressive)"
        required: true
        default: "minimal"
      fast_compress:
        description: "pigz 병렬 압축 사용 (true/false)"
        required: true
        default: "true"
      upgrade_os:
        description: "OS 패키지 업그레이드 (true/false)"
        required: true
        default: "false"
      maven_version:
        description: "Maven 버전(예: 3.9.9) 비우면 apt 기본"
        required: false
        default: ""
      purge_apt_cache:
        description: "Apt 캐시/로그 정리 (true/false)"
        required: true
        default: "false"
      boot_artifact:
        description: "Spring Boot artifactId"
        required: false
        default: "demo-app"
      boot_dependencies:
        description: "Boot deps CSV (web,actuator,...)"
        required: false
        default: "web,actuator"
      container_port_host:
        description: "호스트 포트(기본 18080; JDK21는 +1)"
        required: false
        default: "18080"
      release_prerelease:
        description: "릴리스를 프리릴리스로 표시 (true/false)"
        required: true
        default: "true"
      extras_json:
        description: >-
          설치 토글 JSON. 예)
          {"container_toolchain":true,"k8s_toolchain":true,"security_tools":true,
           "obs_tools":true,"db_images":true,"db_clis":true,
           "build_runtimes":true,"release_utils":true,"docs_tools":true}
        required: false
        default: '{"container_toolchain":true,"k8s_toolchain":true,"security_tools":true,"obs_tools":true,"db_images":true,"db_clis":true,"build_runtimes":true,"release_utils":true,"docs_tools":true}'

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: test-server-ultra-${{ github.ref }}
  cancel-in-progress: true

env:
  BOOT_GROUP: com.example

jobs:
  setup_base:
    runs-on: ubuntu-latest
    continue-on-error: true
    outputs:
      artifact: ${{ steps.cfg.outputs.artifact }}
      deps: ${{ steps.cfg.outputs.deps }}
      base_port: ${{ steps.cfg.outputs.base_port }}
    steps:
      - name: 🛒 Checkout
        uses: actions/checkout@v4
        continue-on-error: true

      - name: 🔧 Config
        id: cfg
        run: |
          echo "artifact=${{ inputs.boot_artifact || 'demo-app' }}" >> $GITHUB_OUTPUT
          echo "deps=${{ inputs.boot_dependencies || 'web,actuator' }}" >> $GITHUB_OUTPUT
          echo "base_port=${{ inputs.container_port_host || '18080' }}" >> $GITHUB_OUTPUT

      - name: 🔎 Runner Info
        run: |
          uname -a || true
          nproc || true
          free -h || true
          df -h || true
          docker version || true
          docker info || true

      - name: 📦 Reserve fast disk (5G)
        run: |
          mkdir -p .github/workflows || true
          sudo fallocate -l 5G .github/workflows/.reserve_space || true
          sudo chmod 666 .github/workflows/.reserve_space || true
          du -h .github/workflows/.reserve_space || true
          df -h || true

      - name: 🛠️ numfmt shim (-4 옵션 무시, bash 호환)
        run: |
          set -Eeuo pipefail
          sudo apt-get update -y || true
          sudo apt-get install -y coreutils jq unzip curl git || true
          sudo mkdir -p /usr/local/bin
          sudo tee /usr/local/bin/numfmt >/dev/null <<'SH'
          #!/usr/bin/env bash
          set -euo pipefail
          TARGET="$(type -aP numfmt | grep -v '^/usr/local/bin/numfmt$' | head -n1)"
          args=()
          for a in "$@"; do [ "$a" = "-4" ] && continue; args+=("$a"); done
          exec "$TARGET" "${args[@]}"
          SH
          sudo chmod +x /usr/local/bin/numfmt
          /usr/local/bin/numfmt -4 --to=iec 1024 || true

      - name: 🧹 Free up disk (profiled)
        uses: jlumbroso/free-disk-space@main
        with:
          android:        ${{ inputs.freedisk_profile == 'aggressive' }}
          dotnet:         ${{ inputs.freedisk_profile == 'aggressive' }}
          haskell:        ${{ inputs.freedisk_profile == 'aggressive' }}
          large-packages: ${{ inputs.freedisk_profile == 'aggressive' }}
          docker-images:  ${{ inputs.freedisk_profile == 'minimal' || inputs.freedisk_profile == 'aggressive' }}
          tool-cache:     ${{ inputs.freedisk_profile == 'minimal' || inputs.freedisk_profile == 'aggressive' }}
          swap-storage:   ${{ inputs.freedisk_profile == 'aggressive' }}

      - name: ⬆️ Upgrade OS (opt)
        if: ${{ inputs.upgrade_os == 'true' }}
        run: |
          sudo apt-get update -y || true
          sudo DEBIAN_FRONTEND=noninteractive apt-get -y upgrade || true
          sudo dpkg --configure -a || true
          sudo apt-get -f install || true

      - name: 🧯 Purge apt cache&logs (opt)
        if: ${{ inputs.purge_apt_cache == 'true' }}
        run: |
          sudo apt-get clean || true
          sudo rm -rf /var/lib/apt/lists/* || true
          sudo journalctl --vacuum-time=1s || true
          sudo find /var/log -type f -name "*.gz" -delete || true
          sudo find /var/log -type f -name "*.1" -delete || true
          df -h || true

      - name: 🧩 Install Extras by JSON toggles (hardened)
        env:
          EXTRAS_JSON: ${{ inputs.extras_json }}
        run: |
          set -Eeuo pipefail

          # ---------- Common base tools ----------
          sudo apt-get update -y || true
          sudo apt-get install -y jq unzip tar zstd pigz aria2 p7zip-full git-lfs gh curl ca-certificates gnupg || true
          git lfs install --system || true

          # ---------- Helpers ----------
          validate_json () { echo "${1:-}" | jq -e . >/dev/null 2>&1; }
          if ! validate_json "${EXTRAS_JSON}"; then
            echo "::warning::extras_json is invalid JSON. All extras disabled for safety."
            EXTRAS_JSON="{}"
          fi
          get_flag(){ printf '%s' "${EXTRAS_JSON}" | jq -r ".\"$1\" // false" 2>/dev/null || echo false; }

          dl() { # url out [retries]
            url="$1"; out="$2"; retries="${3:-3}"
            for i in $(seq 1 "$retries"); do
              if curl -fL --retry 3 --retry-connrefused --retry-delay 2 -o "$out" "$url"; then
                return 0
              fi
              echo "::warning::download failed ($i/$retries): $url"
              sleep 2
            done
            return 1
          }
          continue_or_warn(){ cmd="$1"; msg="$2"; bash -c "$cmd" || echo "::warning::$msg (ignored)"; }
          gh_api(){ curl -fsSL "https://api.github.com/$1"; }

          # ============ 1) Container Toolchain ============
          if [ "$(get_flag container_toolchain)" = "true" ]; then
            echo "[extras] Container toolchain"
            sudo apt-get install -y skopeo || true

            # syft
            continue_or_warn "curl -fsSL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sudo bash -s -- -b /usr/local/bin" "syft install failed"

            # grype
            continue_or_warn "curl -fsSL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sudo bash -s -- -b /usr/local/bin" "grype install failed"

            # trivy
            continue_or_warn "curl -fsSL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin" 'trivy install failed'

            # dive (script + fallback)
            if ! curl -fsSL https://raw.githubusercontent.com/wagoodman/dive/master/install.sh | sudo sh -s -- -b /usr/local/bin; then
              DVER="$(gh_api repos/wagoodman/dive/releases/latest | jq -r .tag_name)"
              ASSET="dive_${DVER#v}_linux_amd64.tar.gz"
              if dl "https://github.com/wagoodman/dive/releases/download/${DVER}/${ASSET}" /tmp/dive.tgz; then
                sudo tar -xzf /tmp/dive.tgz -C /usr/local/bin dive || echo "::warning::dive tar extract failed"
              else
                echo "::warning::dive install failed (all methods)."
              fi
            fi

            # cosign (asset name variants)
            COSVER="$(gh_api repos/sigstore/cosign/releases/latest | jq -r .tag_name)"
            if dl "https://github.com/sigstore/cosign/releases/download/${COSVER}/cosign-linux-amd64" /tmp/cosign; then
              sudo install -m 0755 /tmp/cosign /usr/local/bin/cosign
            elif dl "https://github.com/sigstore/cosign/releases/download/${COSVER}/cosign_${COSVER#v}_linux_amd64.tar.gz" /tmp/cosign.tgz; then
              sudo tar -xzf /tmp/cosign.tgz -C /usr/local/bin cosign || echo "::warning::cosign extract failed"
            else
              echo "::warning::cosign install failed (404 on assets)."
            fi

            # crane
            CRVER="$(gh_api repos/google/go-containerregistry/releases/latest | jq -r .tag_name)"
            if dl "https://github.com/google/go-containerregistry/releases/download/${CRVER}/crane_linux_amd64" /tmp/crane; then
              sudo install -m 0755 /tmp/crane /usr/local/bin/crane
            else
              echo "::warning::crane install failed."
            fi

            # oras
            ORVER="$(gh_api repos/oras-project/oras/releases/latest | jq -r .tag_name)"
            if dl "https://github.com/oras-project/oras/releases/download/${ORVER}/oras_${ORVER#v}_linux_amd64.tar.gz" /tmp/oras.tgz; then
              sudo tar -xzf /tmp/oras.tgz -C /usr/local/bin oras && sudo chmod +x /usr/local/bin/oras || echo "::warning::oras extract failed"
            else
              echo "::warning::oras install failed."
            fi
          fi

          # ============ 2) Cloud & K8s ============
          if [ "$(get_flag k8s_toolchain)" = "true" ]; then
            echo "[extras] Cloud & K8s CLI"
            sudo apt-get install -y curl gnupg || true
            # awscli v2
            if dl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" awscliv2.zip; then unzip -q awscliv2.zip && sudo ./aws/install || true; else echo "::warning::awscli download failed"; fi
            # gcloud
            echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] http://packages.cloud.google.com/apt cloud-sdk main" | \
              sudo tee /etc/apt/sources.list.d/google-cloud-sdk.list
            curl -fsSL https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo gpg --dearmor -o /usr/share/keyrings/cloud.google.gpg
            sudo apt-get update -y && sudo apt-get install -y google-cloud-sdk || echo "::warning::gcloud install failed"
            # azure
            curl -fsSL https://aka.ms/InstallAzureCLIDeb | sudo bash || echo "::warning::azure cli install failed"
            # kubectl
            if dl https://storage.googleapis.com/kubernetes-release/release/stable.txt /tmp/kver; then
              dl "https://storage.googleapis.com/kubernetes-release/release/$(cat /tmp/kver)/bin/linux/amd64/kubectl" /tmp/kubectl && sudo install -m 0755 /tmp/kubectl /usr/local/bin/kubectl || echo "::warning::kubectl install failed"
            fi
            # helm
            continue_or_warn "curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash" "helm install failed"
            # kustomize
            KUSVER="$(gh_api repos/kubernetes-sigs/kustomize/releases/latest | jq -r .tag_name)"
            if dl "https://github.com/kubernetes-sigs/kustomize/releases/download/${KUSVER}/kustomize_${KUSVER#kustomize/}_linux_amd64.tar.gz" /tmp/kus.tgz; then
              sudo tar -xzf /tmp/kus.tgz -C /usr/local/bin kustomize && sudo chmod +x /usr/local/bin/kustomize || echo "::warning::kustomize extract failed"
            else
              echo "::warning::kustomize install failed"
            fi
            # argocd
            if dl https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64 /tmp/argocd; then sudo install -m 0755 /tmp/argocd /usr/local/bin/argocd; else echo "::warning::argocd install failed"; fi
            # yq
            YQVER="$(gh_api repos/mikefarah/yq/releases/latest | jq -r .tag_name)"
            if dl "https://github.com/mikefarah/yq/releases/download/${YQVER}/yq_linux_amd64" /tmp/yq; then sudo install -m 0755 /tmp/yq /usr/local/bin/yq; else echo "::warning::yq install failed"; fi
          fi

          # ============ 3) Security & Lint ============
          if [ "$(get_flag security_tools)" = "true" ]; then
            echo "[extras] Security & Lint"
            sudo apt-get install -y python3-pip shellcheck || true
            GLVER="$(gh_api repos/gitleaks/gitleaks/releases/latest | jq -r .tag_name)"
            if dl "https://github.com/gitleaks/gitleaks/releases/download/${GLVER}/gitleaks_${GLVER#v}_linux_x64.tar.gz" /tmp/gitleaks.tgz; then
              sudo tar -xzf /tmp/gitleaks.tgz -C /usr/local/bin gitleaks && sudo chmod +x /usr/local/bin/gitleaks || echo "::warning::gitleaks extract failed"
            else
              echo "::warning::gitleaks install failed"
            fi
            pip3 install --upgrade pip semgrep bandit || echo "::warning::pip installs failed"
            HADVER="$(gh_api repos/hadolint/hadolint/releases/latest | jq -r .tag_name)"
            if dl "https://github.com/hadolint/hadolint/releases/download/${HADVER}/hadolint-Linux-x86_64" /tmp/hadolint; then sudo install -m 0755 /tmp/hadolint /usr/local/bin/hadolint; else echo "::warning::hadolint install failed"; fi
          fi

          # ============ 4) Observability ============
          if [ "$(get_flag obs_tools)" = "true" ]; then
            echo "[extras] Observability"
            sudo apt-get install -y prometheus-node-exporter unzip || true
            PTVER="$(gh_api repos/grafana/loki/releases/latest | jq -r .tag_name)"
            if dl "https://github.com/grafana/loki/releases/download/${PTVER}/promtail-linux-amd64.zip" /tmp/promtail.zip; then
              unzip -o /tmp/promtail.zip -d /tmp && sudo mv /tmp/promtail-linux-amd64 /usr/local/bin/promtail && sudo chmod +x /usr/local/bin/promtail || echo "::warning::promtail install failed"
            else
              echo "::warning::promtail download failed"
            fi
            if dl https://github.com/open-telemetry/opentelemetry-collector-releases/releases/latest/download/otelcol_linux_amd64.tar.gz /tmp/otel.tgz; then
              sudo tar -xzf /tmp/otel.tgz -C /usr/local/bin otelcol && sudo chmod +x /usr/local/bin/otelcol || echo "::warning::otelcol extract failed"
            else
              echo "::warning::otelcol download failed"
            fi
          fi

          # ============ 5) DB Images ============
          if [ "$(get_flag db_images)" = "true" ]; then
            echo "[extras] DB & Middleware images"
            docker pull postgres:16 || true
            docker pull mysql:8 || true
            docker pull redis:7 || true
            docker pull mongo:7 || true
            docker pull bitnami/kafka:latest || docker pull redpandadata/redpanda:latest || true
            docker pull minio/minio:latest || true
            docker pull minio/mc:latest || true
            docker pull hashicorp/vault:1.16 || true
          fi

          # ============ 6) DB CLIs ============
          if [ "$(get_flag db_clis)" = "true" ]; then
            echo "[extras] DB CLIs"
            sudo apt-get install -y postgresql-client mysql-client redis-tools unzip || true
            if dl https://dl.min.io/client/mc/release/linux-amd64/mc /tmp/mc; then sudo install -m 0755 /tmp/mc /usr/local/bin/mc; fi
            if dl https://releases.hashicorp.com/vault/1.16.3/vault_1.16.3_linux_amd64.zip /tmp/vault.zip; then unzip -o /tmp/vault.zip -d /usr/local/bin && sudo chmod +x /usr/local/bin/vault; fi
            dl https://fastdl.mongodb.org/tools/db/mongodb-database-tools-ubuntu2204-x86_64-100.9.4.deb /tmp/mdb.deb && sudo dpkg -i /tmp/mdb.deb || echo "::warning::mongodb tools install failed"
          fi

          # ============ 7) Build Runtimes ============
          if [ "$(get_flag build_runtimes)" = "true" ]; then
            echo "[extras] Build runtimes"
            curl -s "https://get.sdkman.io" | bash || true
            source "$HOME/.sdkman/bin/sdkman-init.sh" || true
            sudo apt-get install -y python3-pip || true
            pip3 install --upgrade pip pipx poetry || true
            curl -fsSL https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash || true
            export NVM_DIR="$HOME/.nvm"; . "$NVM_DIR/nvm.sh" || true
            nvm install --lts || true
            corepack enable || true
            npm i -g pnpm || true
          fi

          # ============ 8) Release Utils ============
          if [ "$(get_flag release_utils)" = "true" ]; then
            echo "[extras] Release & Transfer tools"
            sudo apt-get install -y rclone || true
          fi

          # ============ 9) Docs Tools ============
          if [ "$(get_flag docs_tools)" = "true" ]; then
            echo "[extras] Docs & Diagram tools"
            sudo apt-get install -y pandoc graphviz default-jre wkhtmltopdf || true
            dl https://sourceforge.net/projects/plantuml/files/plantuml.jar/download /usr/local/bin/plantuml.jar || echo "::warning::plantuml download failed"
          fi

  build_matrix:
    needs: setup_base
    runs-on: ubuntu-latest
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        java: ['17','21']
    env:
      BOOT_ARTIFACT: ${{ needs.setup_base.outputs.artifact }}
      BOOT_DEPS: ${{ needs.setup_base.outputs.deps }}
      BASE_PORT: ${{ needs.setup_base.outputs.base_port }}
      BOOT_GROUP: com.example

    steps:
      - name: 🛒 Checkout
        uses: actions/checkout@v4

      - name: ☕ Setup Java (no cache yet)
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: ${{ matrix.java }}

      - name: 📦 Install Maven (tarball if version set)
        run: |
          VER="${{ inputs.maven_version }}"
          if [ -n "$VER" ]; then
            URL="https://archive.apache.org/dist/maven/maven-3/${VER}/binaries/apache-maven-${VER}-bin.tar.gz"
            TMPD="$(mktemp -d)" || true
            (cd "$TMPD" && curl -fsSL "$URL" -o maven.tgz && tar -xzf maven.tgz) || true
            sudo rm -rf /opt/maven || true; sudo mv "$TMPD/apache-maven-${VER}" /opt/maven || true
            echo "/opt/maven/bin" >> "$GITHUB_PATH"
            rm -rf "$TMPD" || true
          else
            sudo apt-get update -y || true
            sudo apt-get install -y maven unzip pigz || true
          fi
          mvn -v || true

      - name: 🧪 Generate Maven sample + patch (JDK=${{ matrix.java }})
        run: |
          mvn -q -T 1C archetype:generate \
            -DgroupId=com.example -DartifactId=maven-sample \
            -DarchetypeArtifactId=maven-archetype-quickstart \
            -DarchetypeVersion=1.4 -DinteractiveMode=false || true
          cat > maven-sample/pom.xml <<'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
            <modelVersion>4.0.0</modelVersion>
            <groupId>com.example</groupId>
            <artifactId>maven-sample</artifactId>
            <version>1.0.0</version>
            <properties>
              <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
              <maven.compiler.release>__REL__</maven.compiler.release>
            </properties>
            <build>
              <plugins>
                <plugin>
                  <groupId>org.apache.maven.plugins</groupId>
                  <artifactId>maven-compiler-plugin</artifactId>
                  <version>3.11.0</version>
                  <configuration><release>${maven.compiler.release}</release></configuration>
                </plugin>
                <plugin>
                  <groupId>org.apache.maven.plugins</groupId>
                  <artifactId>maven-surefire-plugin</artifactId>
                  <version>3.2.5</version>
                </plugin>
              </plugins>
            </build>
            <dependencies>
              <dependency>
                <groupId>junit</groupId>
                <artifactId>junit</artifactId>
                <version>4.13.2</version>
                <scope>test</scope>
              </dependency>
            </dependencies>
          </project>
          EOF
          sed -i "s/__REL__/${{ matrix.java }}/g" maven-sample/pom.xml || true
          (cd maven-sample && mvn -q -T 1C -DskipTests package) || true
          ls -al maven-sample/target || true

      - name: 🌱 Generate Boot (Maven) + Hello + IT stub
        run: |
          G="${{ env.BOOT_GROUP }}"; A="${{ env.BOOT_ARTIFACT }}"; D="${{ env.BOOT_DEPS }}"; J="${{ matrix.java }}"
          PKG="${G}.${A//-/.}"
          mkdir -p boot-app || true
          curl -fsSL -G https://start.spring.io/starter.zip \
            --data-urlencode "type=maven-project" \
            --data-urlencode "language=java" \
            --data-urlencode "groupId=$G" \
            --data-urlencode "artifactId=$A" \
            --data-urlencode "name=$A" \
            --data-urlencode "packageName=$PKG" \
            --data-urlencode "dependencies=$D" \
            --data-urlencode "javaVersion=$J" \
            --data-urlencode "packaging=jar" \
            -o boot-app.zip || true
          unzip -q -o boot-app.zip -d boot-app || true
          mkdir -p "boot-app/src/main/java/${PKG//.//}/controller"
          cat > "boot-app/src/main/java/${PKG//.//}/controller/HelloController.java" <<EOF
          package ${PKG}.controller;
          import org.springframework.web.bind.annotation.GetMapping;
          import org.springframework.web.bind.annotation.RestController;
          @RestController
          public class HelloController { @GetMapping("/hello") public String hello(){ return "hello"; } }
          EOF
          mkdir -p "boot-app/src/test/java/${PKG//.//}/it"
          cat > "boot-app/src/test/java/${PKG//.//}/it/DemoIT.java" <<EOF
          package ${PKG}.it;
          import org.junit.jupiter.api.Disabled;
          import org.junit.jupiter.api.Test;
          import org.testcontainers.containers.GenericContainer;
          import org.testcontainers.junit.jupiter.Testcontainers;
          @Testcontainers @Disabled("RUN_IT=true 로 활성화")
          public class DemoIT {
            @Test void smoke() {
              try (GenericContainer<?> c = new GenericContainer<>("alpine:3.19").withCommand("sleep","1")) { c.start(); }
            }
          }
          EOF
          mkdir -p boot-app/src/main/resources
          { echo "server.port=8080"; echo "management.endpoints.web.exposure.include=*"; } >> boot-app/src/main/resources/application.properties
          sed -i 's#</dependencies>#  <dependency>\n    <groupId>org.junit.jupiter</groupId>\n    <artifactId>junit-jupiter</artifactId>\n    <version>5.10.2</version>\n    <scope>test</scope>\n  </dependency>\n  <dependency>\n    <groupId>org.testcontainers</groupId>\n    <artifactId>junit-jupiter</artifactId>\n    <version>1.19.7</version>\n    <scope>test</scope>\n  </dependency>\n  <dependency>\n    <groupId>org.testcontainers</groupId>\n    <artifactId>testcontainers</artifactId>\n    <version>1.19.7</version>\n    <scope>test</scope>\n  </dependency>\n</dependencies>#' boot-app/pom.xml || true

      - name: ☕ Enable Maven cache
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: ${{ matrix.java }}
          cache: maven
        # cache-dependency-path 생략해도 pom 자동 탐지됨

      - name: 🏗️ Build Boot (Maven)
        working-directory: boot-app
        run: |
          if [ -x "./mvnw" ]; then ./mvnw -q -T 1C -DskipTests package || true
          else mvn -q -T 1C -DskipTests package || true
          fi
          ls -al target || true

      - name: 🌱 Generate Boot (Gradle)
        run: |
          G="${{ env.BOOT_GROUP }}"; A="${{ env.BOOT_ARTIFACT }}-gradle"; D="${{ env.BOOT_DEPS }}"; J="${{ matrix.java }}"
          PKG="${G}.${A//-/.}"
          mkdir -p boot-app-gradle || true
          curl -fsSL -G https://start.spring.io/starter.zip \
            --data-urlencode "type=gradle-project" \
            --data-urlencode "language=java" \
            --data-urlencode "groupId=$G" \
            --data-urlencode "artifactId=$A" \
            --data-urlencode "name=$A" \
            --data-urlencode "packageName=$PKG" \
            --data-urlencode "dependencies=$D" \
            --data-urlencode "javaVersion=$J" \
            --data-urlencode "packaging=jar" \
            -o boot-app-gradle.zip || true
          unzip -q -o boot-app-gradle.zip -d boot-app-gradle || true
          mkdir -p "boot-app-gradle/src/main/java/${PKG//.//}/controller"
          cat > "boot-app-gradle/src/main/java/${PKG//.//}/controller/HelloController.java" <<EOF
          package ${PKG}.controller;
          import org.springframework.web.bind.annotation.GetMapping;
          import org.springframework.web.bind.annotation.RestController;
          @RestController
          public class HelloController { @GetMapping("/hello") public String hello(){ return "hello-gradle"; } }
          EOF
          sed -i '/dependencies {/a \ \ \ \ testImplementation("org.testcontainers:junit-jupiter:1.19.7")\n\ \ \ \ testImplementation("org.testcontainers:testcontainers:1.19.7")' boot-app-gradle/build.gradle || true

      - name: 🏗️ Build Boot (Gradle)
        working-directory: boot-app-gradle
        run: |
          chmod +x ./gradlew || true
          ./gradlew -q -Dorg.gradle.jvmargs="-Xmx1g" -x test build || true
          ls -al build/libs || true

      - name: 🐳 Setup QEMU/Buildx
        uses: docker/setup-qemu-action@v3
        with:
          platforms: all
      - uses: docker/setup-buildx-action@v3
        with:
          install: true

      - name: 🐳 Create Dockerfile (multi-stage, JDK=${{ matrix.java }})
        working-directory: boot-app
        run: |
          J="${{ matrix.java }}"
          BUILDER="maven:3.9.9-eclipse-temurin-${J}"
          RUNTIME="eclipse-temurin:${J}-jre"
          cat > Dockerfile <<DOCKER
          FROM ${BUILDER} AS builder
          WORKDIR /workspace
          COPY pom.xml .
          COPY src ./src
          RUN --mount=type=cache,target=/root/.m2 mvn -q -DskipTests package
          FROM ${RUNTIME}
          WORKDIR /app
          COPY --from=builder /workspace/target/*.jar /app/app.jar
          EXPOSE 8080
          USER 1000
          ENTRYPOINT ["java","-jar","/app/app.jar"]
          DOCKER
          printf "target/\n.git/\n.github/\n**/*.iml\n**/.DS_Store\n*.log\n" > .dockerignore

      - name: 🐳 Build image (cached) - tag by JDK
        id: docker_build
        working-directory: boot-app
        env:
          IMG: ${{ env.BOOT_ARTIFACT }}:local-j${{ matrix.java }}
        run: |
          mkdir -p /tmp/.buildx-cache-${{ matrix.java }} /tmp/.buildx-cache-new-${{ matrix.java }} || true
          docker buildx build --load -t "${IMG}" \
            --cache-from type=local,src=/tmp/.buildx-cache-${{ matrix.java }} \
            --cache-to   type=local,dest=/tmp/.buildx-cache-new-${{ matrix.java }},mode=max \
            .
          rm -rf /tmp/.buildx-cache-${{ matrix.java }} || true
          mv /tmp/.buildx-cache-new-${{ matrix.java }} /tmp/.buildx-cache-${{ matrix.java }} || true
          echo "image=${IMG}" >> $GITHUB_OUTPUT
          docker images | head -n 20 || true

      - name: 🐳 Save image tar
        working-directory: ${{ github.workspace }}
        env:
          IMG: ${{ steps.docker_build.outputs.image }}
        run: |
          mkdir -p artifacts || true
          docker save "${IMG}" -o artifacts/${IMG/:/_}.tar 2>/dev/null || true

      - name: 🐳 Run container (No-Stop)
        id: docker_run
        env:
          IMG: ${{ steps.docker_build.outputs.image }}
          BASE: ${{ env.BASE_PORT }}
          J: ${{ matrix.java }}
        run: |
          PORT=$BASE; [ "$J" = "21" ] && PORT=$((BASE+1))
          NAME="boot-app-${J}-${GITHUB_RUN_ID}"
          docker run -d --name "${NAME}" -p "${PORT}:8080" "${IMG}" 2>/dev/null || true
          echo "container_name=${NAME}" >> $GITHUB_OUTPUT
          echo "PORT=${PORT}" >> $GITHUB_OUTPUT
          for i in $(seq 1 30); do
            sleep 2
            curl -fsS "http://localhost:${PORT}/actuator/health" && break || true
            curl -fsS "http://localhost:${PORT}/hello" && break || true
            echo "[echo] waiting app(${J})... ($i)"
          done
          curl -fsS "http://localhost:${PORT}/hello" || true
          docker logs --tail 120 "${NAME}" 2>/dev/null || true

      - name: ⬆️ Upload artifacts (per JDK)
        uses: actions/upload-artifact@v4
        with:
          name: bundles-j${{ matrix.java }}
          path: |
            artifacts/*
            maven-sample/target/*.jar
            boot-app/target/*.jar
            boot-app/Dockerfile
            boot-app/.dockerignore
            boot-app-gradle/build/libs/*.jar
          if-no-files-found: warn
          retention-days: 7

  release:
    needs: [setup_base, build_matrix]
    runs-on: ubuntu-latest
    continue-on-error: false
    steps:
      - name: ⬇️ Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: release_artifacts

      - name: 🧾 List artifacts
        run: |
          echo "== release_artifacts =="; find release_artifacts -type f | sed 's/^/- /' || true

      - name: 🧰 Normalize & de-duplicate → release-bundle/
        run: |
          set -Eeuo pipefail
          mkdir -p release-bundle
          declare -A seen=()
          while IFS= read -r -d '' f; do
            base="$(basename "$f")"
            ext="${base##*.}"
            stem="${base%.*}"
            sfx=""
            case "$f" in
              *bundles-j17/*) sfx="${sfx:+$sfx-}j17";;
              *bundles-j21/*) sfx="${sfx:+$sfx-}j21";;
            esac
            case "$f" in
              */boot-app-gradle/*|*gradle/*) sfx="${sfx:+$sfx-}gradle";;
              */boot-app/*|*maven-sample/*)  sfx="${sfx:+$sfx-}maven";;
            esac
            out="${base}"
            [ -n "$sfx" ] && out="${stem}-${sfx}.${ext}"
            key="$out"
            if [[ -n "${seen[$key]:-}" ]]; then
              cnt="${seen[$key]}"
              seen["$key"]=$((cnt+1))
              out="${stem}-${sfx:+$sfx-}dup$((cnt+1)).${ext}"
            else
              seen["$key"]=1
            fi
            cp -f "$f" "release-bundle/$out"
          done < <(find release_artifacts -type f -print0)
          echo "== release-bundle =="; (cd release-bundle && ls -al) || true

      - name: 🚀 Create/Update Release with GH CLI (clobber, no git)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -Eeuo pipefail
          TAG="auto-${{ github.run_number }}"
          TITLE="Auto Release #${{ github.run_number }}"
          REPO="${{ github.repository }}"
          if ! gh release view "$TAG" --repo "$REPO" >/dev/null 2>&1; then
            if [ "${{ inputs.release_prerelease }}" = "true" ]; then
              gh release create "$TAG" --title "$TITLE" --notes "" --prerelease --repo "$REPO"
            else
              gh release create "$TAG" --title "$TITLE" --notes "" --repo "$REPO"
            fi
          fi
          gh release upload "$TAG" release-bundle/** --clobber --repo "$REPO"

  promote_to_prod:
    needs: [setup_base, build_matrix]
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: ⬇️ Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: stage_artifacts

      - name: 📦 Promote artifacts → prod (rename/retag tar)
        run: |
          mkdir -p prod_artifacts
          find stage_artifacts -type f -name "*.tar" -print0 | while IFS= read -r -d '' f; do
            base="$(basename "$f")"
            prod="${base/local/prod}"
            cp -f "$f" "prod_artifacts/${prod}"
          done
          find stage_artifacts -type f \( -name "*.jar" -o -name "*.tgz" \) -print0 | while IFS= read -r -d '' f; do
            cp -f "$f" "prod_artifacts/$(basename "$f")"
          done
          echo "== prod_artifacts =="; ls -al prod_artifacts || true

      - name: ⬆️ Upload prod bundle
        uses: actions/upload-artifact@v4
        with:
          name: prod-bundles
          path: prod_artifacts/*
          if-no-files-found: warn
          retention-days: 14

      - name: 🛒 Checkout (for PR)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: 📝 Create a PROD workflow copy (PR)
        run: |
          mkdir -p .github/workflows
          cat > .github/workflows/test1-prod.yml <<'YML'
          name: PROD Runner (wrapper)
          on:
            workflow_dispatch:
          jobs:
            info:
              runs-on: ubuntu-latest
              steps:
                - run: echo "This is a placeholder PROD workflow. It exists as a copy for ops traceability."
          YML

      - name: 🔁 Open PR for PROD workflow copy
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(prod): add prod workflow copy & promote bundles"
          title: "chore(prod): add prod workflow copy & promote bundles"
          body: |
            자동 생성된 PROD 워크플로우 래퍼 및 프로모션 번들 업로드.
            - test1-prod.yml 추가(운영 추적용)
            - 아티팩트(prod-bundles) 포함
          branch: promote/prod-${{ github.run_id }}
          delete-branch: true
