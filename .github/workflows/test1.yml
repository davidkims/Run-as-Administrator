name: Test-Server + Spring Boot + Docker (Ultra Integrated - Hardened v2-help)

on:
  schedule:
    - cron: "*/10 * * * *"
  workflow_dispatch:
    inputs:
      freedisk_profile:
        description: "FreeDisk í”„ë¡œíŒŒì¼ (none|minimal|aggressive)"
        required: true
        default: "minimal"
      fast_compress:
        description: "pigz ë³‘ë ¬ ì••ì¶• ì‚¬ìš© (true/false)"
        required: true
        default: "true"
      upgrade_os:
        description: "OS íŒ¨í‚¤ì§€ ì—…ê·¸ë ˆì´ë“œ (true/false)"
        required: true
        default: "false"
      maven_version:
        description: "Maven ë²„ì „(ì˜ˆ: 3.9.9) ë¹„ìš°ë©´ apt ê¸°ë³¸"
        required: false
        default: ""
      purge_apt_cache:
        description: "Apt ìºì‹œ/ë¡œê·¸ ì •ë¦¬ (true/false)"
        required: true
        default: "false"
      boot_artifact:
        description: "Spring Boot artifactId"
        required: false
        default: "demo-app"
      boot_dependencies:
        description: "Boot deps CSV (web,actuator,...)"
        required: false
        default: "web,actuator"
      container_port_host:
        description: "í˜¸ìŠ¤íŠ¸ í¬íŠ¸(ê¸°ë³¸ 18080; JDK21ëŠ” +1)"
        required: false
        default: "18080"
      release_prerelease:
        description: "ë¦´ë¦¬ìŠ¤ë¥¼ í”„ë¦¬ë¦´ë¦¬ìŠ¤ë¡œ í‘œì‹œ (true/false)"
        required: true
        default: "true"
      extras_json:
        description: >-
          ì„¤ì¹˜ í† ê¸€ JSON. ì˜ˆ)
          {"container_toolchain":true,"k8s_toolchain":true,"security_tools":true,
           "obs_tools":true,"db_images":true,"db_clis":true,
           "build_runtimes":true,"release_utils":true,"docs_tools":true}
        required: false
        default: '{"container_toolchain":true,"k8s_toolchain":true,"security_tools":true,"obs_tools":true,"db_images":true,"db_clis":true,"build_runtimes":true,"release_utils":true,"docs_tools":true}'

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: test-server-ultra-${{ github.ref }}
  cancel-in-progress: true

env:
  BOOT_GROUP: com.example
  DEFAULT_EXTRAS_JSON: >-
    {"container_toolchain":true,"k8s_toolchain":true,"security_tools":true,
     "obs_tools":true,"db_images":true,"db_clis":true,
     "build_runtimes":true,"release_utils":true,"docs_tools":true}

jobs:
  setup_base:
    runs-on: ubuntu-latest
    continue-on-error: true
    outputs:
      artifact: ${{ steps.cfg.outputs.artifact }}
      deps: ${{ steps.cfg.outputs.deps }}
      base_port: ${{ steps.cfg.outputs.base_port }}
    steps:
      - name: ğŸ›’ Checkout
        uses: actions/checkout@v4
        continue-on-error: true

      - name: ğŸ§° Write helper library (Help/Manual)
        id: helper
        run: |
          cat > /tmp/echo_helpers.sh <<'EOSH'
          #!/usr/bin/env bash
          set -Eeo pipefail
          : "${ECHO_FAILS:=/tmp/_fails.log}"
          : "${ECHO_HELP:=/tmp/_help.log}"

          note(){ printf "::notice::%s\n" "$*"; }
          warn(){ printf "::warning::%s\n" "$*"; }
          err (){ printf "::error::%s\n"   "$*"; }

          record_fail(){  # code stage detail
            code="$1"; stage="$2"; shift 2 || true
            detail="$*"
            printf "%s|%s|%s\n" "$code" "$stage" "$detail" >> "$ECHO_FAILS"
            help_topic "$code" "$stage" "$detail" >> "$ECHO_HELP" || true
          }

          # ---- HELP MANUAL DISPATCHER ----
          help_topic(){ # code stage detail -> prints manual
            code="$1"; stage="$2"; detail="$3"
            case "$code" in
              JSON_INVALID)
                cat <<'EOF'
                [HELP] extras_json ë¬´íš¨(ë¹ˆ ê°’/í˜•ì‹ ì˜¤ë¥˜)
                - ì›ì¸: schedule ì‹¤í–‰ ë˜ëŠ” ì˜ëª»ëœ JSON ë¬¸ìì—´
                - ì¡°ì¹˜:
                  1) ì›Œí¬í”Œë¡œìš° ìˆ˜ë™ ì‹¤í–‰ ì‹œ extras_jsonì„ ìœ íš¨í•œ JSONìœ¼ë¡œ ì…ë ¥
                  2) ë¹„ìƒ í´ë°±(DEFAULT_EXTRAS_JSON)ì´ ì´ë¯¸ ì ìš©ë˜ì–´ ì‹¤í–‰ì€ ê³„ì†ë¨
                  3) jq ê²€ì¦: echo '<json>' | jq .
                EOF
                ;;
              DL_FAIL)
                cat <<'EOF'
                [HELP] íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨
                - ê³µí†µ ì ê²€:
                  1) URL ì ‘ê·¼ ê°€ëŠ¥ ì—¬ë¶€(curl -I)
                  2) ë„¤íŠ¸ì›Œí¬ ì¼ì‹œ ì¥ì•  â†’ ì¬ì‹œë„
                  3) í”„ë¡ì‹œ/ë°©í™”ë²½ ë³€ìˆ˜ í™•ì¸(HTTP_PROXY/HTTPS_PROXY/NO_PROXY)
                - ëŒ€ì²´:
                  * gh API ìì‚° ê²½ë¡œë¡œ ìš°íšŒ ë‹¤ìš´ë¡œë“œ ë˜ëŠ” ì»¨í…Œì´ë„ˆ ë˜í¼ ì‚¬ìš©
                EOF
                ;;
              HEREDOC)
                cat <<'EOF'
                [HELP] Here-Doc êµ¬ë¬¸ ì—ëŸ¬
                - ì›ì¸: ì¢…ë£Œ í† í°(EOF/SH) ëˆ„ë½/ë¶ˆì¼ì¹˜
                - ì¡°ì¹˜:
                  1) <<'EOF' ë¡œ ê°ì‹¸ê³  ë™ì¼í•œ 'EOF'ë¡œ ë‹«ê¸°
                  2) ë“¤ì—¬ì“°ê¸° ì—†ëŠ” ë‹¨ë… ë¼ì¸ì— ì¢…ë£Œ í† í° ë°°ì¹˜
                EOF
                ;;
              GH_UPLOAD_0B)
                cat <<'EOF'
                [HELP] GitHub Release 400 Bad Content-Length
                - ì›ì¸: 0ë°”ì´íŠ¸ íŒŒì¼ ì—…ë¡œë“œ ì‹œë„
                - ì¡°ì¹˜:
                  1) find -size +0c ë¡œ ë¹„ì–´ìˆëŠ” íŒŒì¼ ì œì™¸ í›„ ì—…ë¡œë“œ
                  2) ìƒì„± ë‹¨ê³„ì—ì„œ ì‚°ì¶œë¬¼ì´ ë¹„ì–´ìˆì§€ ì•Šì€ì§€ í™•ì¸
                EOF
                ;;
              GH_AUTH)
                cat <<'EOF'
                [HELP] GH CLI ì¸ì¦/ê¶Œí•œ ë¬¸ì œ
                - ì ê²€:
                  1) GH_TOKEN(GITHUB_TOKEN) ê¶Œí•œ: contents:write í•„ìš”
                  2) gh auth status
                EOF
                ;;
              DOCKER_DAEMON)
                cat <<'EOF'
                [HELP] Docker ë°ëª¬/ê¶Œí•œ ë¬¸ì œ
                - ì ê²€:
                  1) docker info / docker version ê²°ê³¼ í™•ì¸
                  2) ëŸ°ë„ˆ ì´ë¯¸ì§€ ì •ì±…(í”„ë¦¬ë¹Œë¦¬ì§€) í™•ì¸
                - ìš°íšŒ:
                  * buildx --load ëŒ€ì‹  --output type=oci ì‚¬ìš©, í˜¹ì€ rootless ë¹Œë“œ ê²€í† 
                EOF
                ;;
              DOCKER_BUILD)
                cat <<'EOF'
                [HELP] Docker ë¹Œë“œ ì‹¤íŒ¨
                - ì ê²€:
                  1) Dockerfile êµ¬ë¬¸/ê²½ë¡œ(COPY ëŒ€ìƒ) í™•ì¸
                  2) ìºì‹œ ë””ë ‰í† ë¦¬ ì ‘ê·¼ê¶Œí•œ
                  3) ë² ì´ìŠ¤ ì´ë¯¸ì§€ íƒœê·¸ ì¡´ì¬ ì—¬ë¶€
                EOF
                ;;
              CONTAINER_HEALTH)
                cat <<'EOF'
                [HELP] ì»¨í…Œì´ë„ˆ ê¸°ë™/í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨
                - ì ê²€:
                  1) í¬íŠ¸ ì¶©ëŒ ì—¬ë¶€(í•´ë‹¹ í¬íŠ¸ ë¦¬ìŠ¤ë‹ ì¤‘ì¸ì§€)
                  2) ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œê·¸ ì—ëŸ¬(docker logs)
                  3) /actuator/health ë…¸ì¶œ ì—¬ë¶€ì™€ server.port ì„¤ì •
                - ì„ì‹œ ì¡°ì¹˜:
                  * ì¬ì‹œë„ ë£¨í”„ ì¦ê°€ / ëŒ€ê¸° ì‹œê°„ í™•ëŒ€
                EOF
                ;;
              MVN_BUILD)
                cat <<'EOF'
                [HELP] Maven ë¹Œë“œ ì‹¤íŒ¨
                - ì ê²€:
                  1) JDK ë²„ì „/ì†ŒìŠ¤ ë¦´ë¦¬ì¦ˆ í˜¸í™˜ì„±(maven-compiler-plugin release)
                  2) í”„ë¡ì‹œ ì„¤ì •(~/.m2/settings.xml)
                  3) ì €ì¥ì†Œ ì¥ì•  ì‹œ ì¬ì‹œë„
                EOF
                ;;
              GRADLE_BUILD)
                cat <<'EOF'
                [HELP] Gradle ë¹Œë“œ ì‹¤íŒ¨
                - ì ê²€:
                  1) gradlew ì‹¤í–‰ê¶Œí•œ(chmod +x)
                  2) JVM ë©”ëª¨ë¦¬(-Xmx) ì¡°ì •
                  3) í”ŒëŸ¬ê·¸ì¸/ë ˆí¬ ì ‘ê·¼ì„±
                EOF
                ;;
              APT_LOCK)
                cat <<'EOF'
                [HELP] apt ë½/íŒ¨í‚¤ì§€ ì¶©ëŒ
                - ì¡°ì¹˜:
                  1) sudo dpkg --configure -a
                  2) sudo apt-get -f install
                  3) sudo rm -rf /var/lib/apt/lists/* && sudo apt-get update
                EOF
                ;;
              DISK_FULL)
                cat <<'EOF'
                [HELP] ë””ìŠ¤í¬ ìš©ëŸ‰ ë¶€ì¡±
                - ì¡°ì¹˜:
                  1) FreeDisk ì•¡ì…˜ í”„ë¡œíŒŒì¼ì„ minimal/aggressiveë¡œ
                  2) /var/log ì •ë¦¬ ë° Docker ì´ë¯¸ì§€/ë ˆì´ì–´ ì‚­ì œ
                  3) ì„ì‹œ íŒŒì¼/ìºì‹œ ì œê±°
                EOF
                ;;
              START_SPRING)
                cat <<'EOF'
                [HELP] start.spring.io ì ‘ê·¼ ì‹¤íŒ¨
                - ì¡°ì¹˜:
                  1) ë„¤íŠ¸ì›Œí¬/í”„ë¡ì‹œ ì ê²€
                  2) ìˆ˜ë™ìœ¼ë¡œ í”„ë¡œì íŠ¸ ZIP ë‚´ë ¤ë°›ì•„ ì»¤ë°‹ í›„ ë¹Œë“œ ì§„í–‰
                EOF
                ;;
              K8S_CLI)
                cat <<'EOF'
                [HELP] K8s/Cloud CLI ì„¤ì¹˜ ì‹¤íŒ¨
                - ì¡°ì¹˜:
                  1) GPG í‚¤/ë ˆí¬ í‚¤ë§ ê²½ë¡œ ê²€ì¦
                  2) ì¬ì‹œë„ ë˜ëŠ” ë°”ì´ë„ˆë¦¬ ì§ì ‘ ë‹¤ìš´ë¡œë“œ(ë¦´ë¦¬ìŠ¤ ìì‚°)
                EOF
                ;;
              *)
                cat <<EOF
                [HELP] ì¼ë°˜ ì˜¤ë¥˜ ì½”ë“œ(${code}) @ ${stage}
                - ìƒì„¸: ${detail}
                - ê³µí†µ ì ê²€: ë„¤íŠ¸ì›Œí¬, ê¶Œí•œ, ê²½ë¡œ, íƒœê·¸ ì¡´ì¬ ì—¬ë¶€, ìš©ëŸ‰/ë©”ëª¨ë¦¬
                EOF
                ;;
            esac
          }

          show_help_summary(){
            if [ -s "$ECHO_FAILS" ]; then
              echo "====== ğŸ†˜ Failure Summary ======"
              cat "$ECHO_FAILS" | nl -ba
              echo
              echo "====== ğŸ“– Help Manual (merged) ======"
              awk 'BEGIN{RS="";ORS="\n\n"}1' "$ECHO_HELP" || cat "$ECHO_HELP"
            else
              note "No failures recorded. Help summary skipped."
            fi
          }
          EOSH
          chmod +x /tmp/echo_helpers.sh
          echo "ok=1" >> "$GITHUB_OUTPUT"

      - name: ğŸ”§ Config
        id: cfg
        run: |
          source /tmp/echo_helpers.sh
          CURRENT_STAGE="config"
          echo "artifact=${{ inputs.boot_artifact || 'demo-app' }}" >> "$GITHUB_OUTPUT" || record_fail JSON_INVALID "$CURRENT_STAGE" "artifact output write"
          echo "deps=${{ inputs.boot_dependencies || 'web,actuator' }}" >> "$GITHUB_OUTPUT" || record_fail JSON_INVALID "$CURRENT_STAGE" "deps output write"
          echo "base_port=${{ inputs.container_port_host || '18080' }}" >> "$GITHUB_OUTPUT" || record_fail JSON_INVALID "$CURRENT_STAGE" "port output write"

      - name: ğŸ” Runner Info
        run: |
          source /tmp/echo_helpers.sh
          CURRENT_STAGE="runner-info"
          uname -a || warn "uname failed"
          nproc || warn "nproc failed"
          free -h || warn "free failed"
          df -h || warn "df failed"
          docker version || record_fail DOCKER_DAEMON "$CURRENT_STAGE" "docker version"
          docker info    || record_fail DOCKER_DAEMON "$CURRENT_STAGE" "docker info"

      - name: ğŸ“¦ Reserve fast disk (5G)
        run: |
          source /tmp/echo_helpers.sh
          CURRENT_STAGE="reserve-disk"
          mkdir -p .github/workflows || true
          if ! sudo fallocate -l 5G .github/workflows/.reserve_space; then
            record_fail DISK_FULL "$CURRENT_STAGE" "fallocate 5G ì‹¤íŒ¨"
          fi
          sudo chmod 666 .github/workflows/.reserve_space || true
          du -h .github/workflows/.reserve_space || true
          df -h || true

      - name: ğŸ› ï¸ numfmt shim (-4 ë¬´ì‹œ)
        run: |
          source /tmp/echo_helpers.sh
          CURRENT_STAGE="numfmt-shim"
          set -Eeuo pipefail
          if ! (sudo apt-get update -y && sudo apt-get install -y coreutils jq unzip curl git); then
            record_fail APT_LOCK "$CURRENT_STAGE" "apt install coreutils/jq ë“±"
          fi
          sudo mkdir -p /usr/local/bin
          cat > /tmp/_numfmt.sh <<'EOF'
          #!/usr/bin/env bash
          set -euo pipefail
          TARGET="$(command -v numfmt || true)"
          if [ -z "${TARGET:-}" ]; then
            echo "numfmt not found" >&2; exit 127
          fi
          args=()
          for a in "$@"; do [ "$a" = "-4" ] && continue; args+=("$a"); done
          exec "$TARGET" "${args[@]}"
          EOF
          sudo mv /tmp/_numfmt.sh /usr/local/bin/numfmt && sudo chmod +x /usr/local/bin/numfmt
          /usr/local/bin/numfmt -4 --to=iec 1024 || true

      - name: ğŸ§¹ Free up disk (profiled)
        uses: jlumbroso/free-disk-space@main
        with:
          android:        ${{ inputs.freedisk_profile == 'aggressive' }}
          dotnet:         ${{ inputs.freedisk_profile == 'aggressive' }}
          haskell:        ${{ inputs.freedisk_profile == 'aggressive' }}
          large-packages: ${{ inputs.freedisk_profile == 'aggressive' }}
          docker-images:  ${{ inputs.freedisk_profile == 'minimal' || inputs.freedisk_profile == 'aggressive' }}
          tool-cache:     ${{ inputs.freedisk_profile == 'minimal' || inputs.freedisk_profile == 'aggressive' }}
          swap-storage:   ${{ inputs.freedisk_profile == 'aggressive' }}

      - name: â¬†ï¸ Upgrade OS (opt)
        if: ${{ inputs.upgrade_os == 'true' }}
        run: |
          source /tmp/echo_helpers.sh
          CURRENT_STAGE="apt-upgrade"
          sudo apt-get update -y || record_fail APT_LOCK "$CURRENT_STAGE" "apt update"
          sudo DEBIAN_FRONTEND=noninteractive apt-get -y upgrade || record_fail APT_LOCK "$CURRENT_STAGE" "apt upgrade"
          sudo dpkg --configure -a || true
          sudo apt-get -f install || true

      - name: ğŸ§¯ Purge apt cache&logs (opt)
        if: ${{ inputs.purge_apt_cache == 'true' }}
        run: |
          source /tmp/echo_helpers.sh
          CURRENT_STAGE="apt-purge"
          sudo apt-get clean || true
          sudo rm -rf /var/lib/apt/lists/* || true
          sudo journalctl --vacuum-time=1s || true
          sudo find /var/log -type f -name "*.gz" -delete || true
          sudo find /var/log -type f -name "*.1" -delete || true
          df -h || true

      - name: ğŸ§© Install Extras by JSON toggles (API/fallback + Help)
        env:
          RAW_EXTRAS_JSON: ${{ inputs.extras_json }}
        run: |
          source /tmp/echo_helpers.sh
          CURRENT_STAGE="extras"
          set -Eeuo pipefail
          sudo apt-get update -y || record_fail APT_LOCK "$CURRENT_STAGE" "apt update"
          sudo apt-get install -y jq unzip tar zstd pigz aria2 p7zip-full git-lfs gh curl ca-certificates gnupg || record_fail APT_LOCK "$CURRENT_STAGE" "apt install extras"
          git lfs install || true

          EXTRAS_JSON="${RAW_EXTRAS_JSON:-}"
          if ! printf '%s' "${EXTRAS_JSON}" | jq -e . >/dev/null 2>&1; then
            note "extras_json invalid â†’ DEFAULT_EXTRAS_JSON ì‚¬ìš©"
            EXTRAS_JSON='${{ env.DEFAULT_EXTRAS_JSON }}'
            record_fail JSON_INVALID "$CURRENT_STAGE" "fallback to DEFAULT_EXTRAS_JSON"
          fi

          gh_api(){ curl -fsSL "https://api.github.com/$1"; }
          dl(){ url="$1"; out="$2"; retries="${3:-3}"; for i in $(seq 1 "$retries"); do curl -fL --retry 3 --retry-connrefused --retry-delay 2 -o "$out" "$url" && return 0 || warn "download failed ($i/$retries): $url"; sleep 2; done; return 1; }
          gh_dl_asset(){ owner="$1"; repo="$2"; filt="$3"; out="$4"; rel="$(gh_api repos/${owner}/${repo}/releases/latest | jq -r '.tag_name, (.assets // [])[]?.browser_download_url' 2>/dev/null || true)"; url="$(echo "$rel" | awk '/^https?:/ {print}' | grep -iE "$filt" | head -n1 || true)"; [ -z "$url" ] && return 1; dl "$url" "$out"; }
          make_wrapper(){ name="$1"; image="$2"; sudo tee "/usr/local/bin/${name}" >/dev/null <<EOF
          #!/usr/bin/env bash
          exec docker run --rm -i --net=host -v "\$PWD:/work" -w /work ${image} ${name} "\$@"
          EOF
          sudo chmod +x "/usr/local/bin/${name}"; }

          get_flag(){ printf '%s' "${EXTRAS_JSON}" | jq -r ".\"$1\" // false" 2>/dev/null || echo false; }

          # (í•˜ìœ„ ì„¤ì¹˜ ë¡œì§ì€ ë™ì¼ â€” ì‹¤íŒ¨ ì‹œ record_failë¡œ í—¬í”„ ìˆ˜ì§‘)
          if [ "$(get_flag container_toolchain)" = "true" ]; then
            sudo apt-get install -y skopeo || record_fail APT_LOCK "$CURRENT_STAGE" "install skopeo"
            curl -fsSL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sudo bash -s -- -b /usr/local/bin || record_fail DL_FAIL "$CURRENT_STAGE" "syft"
            curl -fsSL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sudo bash -s -- -b /usr/local/bin || record_fail DL_FAIL "$CURRENT_STAGE" "grype"
            curl -fsSL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin || record_fail DL_FAIL "$CURRENT_STAGE" "trivy"
            if ! curl -fsSL https://raw.githubusercontent.com/wagoodman/dive/master/install.sh | sudo sh -s -- -b /usr/local/bin; then
              gh_dl_asset wagoodman dive "linux_amd64.*\.tar\.gz" /tmp/dive.tgz || record_fail DL_FAIL "$CURRENT_STAGE" "dive"
              sudo tar -xzf /tmp/dive.tgz -C /usr/local/bin dive || record_fail HEREDOC "$CURRENT_STAGE" "dive extract"
            fi
            if ! dl "https://github.com/sigstore/cosign/releases/latest/download/cosign-linux-amd64" /tmp/cosign; then
              gh_dl_asset sigstore cosign "linux_amd64.*\.tar\.gz" /tmp/cosign.tgz || record_fail DL_FAIL "$CURRENT_STAGE" "cosign asset"
              sudo tar -xzf /tmp/cosign.tgz -C /usr/local/bin cosign || record_fail DOCKER_BUILD "$CURRENT_STAGE" "cosign extract"
            else
              sudo install -m 0755 /tmp/cosign /usr/local/bin/cosign || record_fail DOCKER_BUILD "$CURRENT_STAGE" "cosign install"
            fi
            if ! gh_dl_asset google go-containerregistry "crane_linux_amd64$" /tmp/crane; then
              docker pull gcr.io/go-containerregistry/crane:debug || record_fail DOCKER_DAEMON "$CURRENT_STAGE" "pull crane:debug"
              make_wrapper crane gcr.io/go-containerregistry/crane:debug
            else
              sudo install -m 0755 /tmp/crane /usr/local/bin/crane || record_fail DOCKER_BUILD "$CURRENT_STAGE" "crane install"
            fi
            if gh_dl_asset oras-project oras "linux_amd64.*\.tar\.gz" /tmp/oras.tgz; then
              sudo tar -xzf /tmp/oras.tgz -C /usr/local/bin oras && sudo chmod +x /usr/local/bin/oras || record_fail DOCKER_BUILD "$CURRENT_STAGE" "oras extract"
            fi
          fi

          if [ "$(get_flag k8s_toolchain)" = "true" ]; then
            dl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" awscliv2.zip || record_fail DL_FAIL "$CURRENT_STAGE" "awscli zip"
            unzip -q awscliv2.zip || record_fail DL_FAIL "$CURRENT_STAGE" "aws unzip"
            sudo ./aws/install || record_fail K8S_CLI "$CURRENT_STAGE" "aws install"
            echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] http://packages.cloud.google.com/apt cloud-sdk main" | sudo tee /etc/apt/sources.list.d/google-cloud-sdk.list >/dev/null
            curl -fsSL https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo gpg --dearmor -o /usr/share/keyrings/cloud.google.gpg || record_fail K8S_CLI "$CURRENT_STAGE" "gpg dearmor"
            sudo apt-get update -y || record_fail APT_LOCK "$CURRENT_STAGE" "gcloud apt update"
            sudo apt-get install -y google-cloud-sdk || record_fail K8S_CLI "$CURRENT_STAGE" "gcloud install"
            curl -fsSL https://aka.ms/InstallAzureCLIDeb | sudo bash || record_fail K8S_CLI "$CURRENT_STAGE" "azure cli"
            dl https://storage.googleapis.com/kubernetes-release/release/stable.txt /tmp/kver || record_fail DL_FAIL "$CURRENT_STAGE" "stable.txt"
            dl "https://storage.googleapis.com/kubernetes-release/release/$(cat /tmp/kver)/bin/linux/amd64/kubectl" /tmp/kubectl || record_fail DL_FAIL "$CURRENT_STAGE" "kubectl"
            sudo install -m 0755 /tmp/kubectl /usr/local/bin/kubectl || record_fail K8S_CLI "$CURRENT_STAGE" "kubectl install"
            curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash || record_fail K8S_CLI "$CURRENT_STAGE" "helm"
            KUSVER="$(curl -fsSL https://api.github.com/repos/kubernetes-sigs/kustomize/releases/latest | jq -r .tag_name)"
            dl "https://github.com/kubernetes-sigs/kustomize/releases/download/${KUSVER}/kustomize_${KUSVER#kustomize/}_linux_amd64.tar.gz" /tmp/kus.tgz || record_fail DL_FAIL "$CURRENT_STAGE" "kustomize"
            sudo tar -xzf /tmp/kus.tgz -C /usr/local/bin kustomize || record_fail K8S_CLI "$CURRENT_STAGE" "kustomize extract"
            dl https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64 /tmp/argocd || record_fail DL_FAIL "$CURRENT_STAGE" "argocd"
            sudo install -m 0755 /tmp/argocd /usr/local/bin/argocd || record_fail K8S_CLI "$CURRENT_STAGE" "argocd install"
            YQVER="$(curl -fsSL https://api.github.com/repos/mikefarah/yq/releases/latest | jq -r .tag_name)"
            dl "https://github.com/mikefarah/yq/releases/download/${YQVER}/yq_linux_amd64" /tmp/yq || record_fail DL_FAIL "$CURRENT_STAGE" "yq"
            sudo install -m 0755 /tmp/yq /usr/local/bin/yq || record_fail K8S_CLI "$CURRENT_STAGE" "yq install"
          fi

          if [ "$(get_flag security_tools)" = "true" ]; then
            sudo apt-get install -y python3-pip shellcheck || record_fail APT_LOCK "$CURRENT_STAGE" "security tools"
            GLVER="$(curl -fsSL https://api.github.com/repos/gitleaks/gitleaks/releases/latest | jq -r .tag_name)"
            dl "https://github.com/gitleaks/gitleaks/releases/download/${GLVER}/gitleaks_${GLVER#v}_linux_x64.tar.gz" /tmp/gitleaks.tgz || record_fail DL_FAIL "$CURRENT_STAGE" "gitleaks"
            sudo tar -xzf /tmp/gitleaks.tgz -C /usr/local/bin gitleaks || record_fail DOCKER_BUILD "$CURRENT_STAGE" "gitleaks extract"
            pip3 install --upgrade pip semgrep bandit || record_fail DL_FAIL "$CURRENT_STAGE" "pip semgrep bandit"
            HADVER="$(curl -fsSL https://api.github.com/repos/hadolint/hadolint/releases/latest | jq -r .tag_name)"
            dl "https://github.com/hadolint/hadolint/releases/download/${HADVER}/hadolint-Linux-x86_64" /tmp/hadolint || record_fail DL_FAIL "$CURRENT_STAGE" "hadolint"
            sudo install -m 0755 /tmp/hadolint /usr/local/bin/hadolint || record_fail DOCKER_BUILD "$CURRENT_STAGE" "hadolint install"
          fi

          if [ "$(get_flag obs_tools)" = "true" ]; then
            sudo apt-get install -y prometheus-node-exporter unzip || record_fail APT_LOCK "$CURRENT_STAGE" "prometheus-node-exporter"
            PTVER="$(curl -fsSL https://api.github.com/repos/grafana/loki/releases/latest | jq -r .tag_name)"
            dl "https://github.com/grafana/loki/releases/download/${PTVER}/promtail-linux-amd64.zip" /tmp/promtail.zip || record_fail DL_FAIL "$CURRENT_STAGE" "promtail zip"
            unzip -o /tmp/promtail.zip -d /tmp || record_fail DL_FAIL "$CURRENT_STAGE" "promtail unzip"
            sudo mv /tmp/promtail-linux-amd64 /usr/local/bin/promtail && sudo chmod +x /usr/local/bin/promtail || record_fail DOCKER_BUILD "$CURRENT_STAGE" "promtail install"
            if ! gh_dl_asset open-telemetry opentelemetry-collector-releases "otelcol_.*linux_amd64.*\.tar\.gz" /tmp/otelcol.tgz; then
              warn "otelcol binary fetch failed; using docker wrapper"
              docker pull otel/opentelemetry-collector:latest || record_fail DOCKER_DAEMON "$CURRENT_STAGE" "otelcol docker pull"
              cat >/usr/local/bin/otelcol <<'EOF'
              #!/usr/bin/env bash
              exec docker run --rm --net=host -v "$PWD:/work" -w /work -v /var/log:/var/log -v /etc:/etc otel/opentelemetry-collector:latest "$@"
              EOF
              chmod +x /usr/local/bin/otelcol
            else
              sudo tar -xzf /tmp/otelcol.tgz -C /usr/local/bin otelcol || record_fail DOCKER_BUILD "$CURRENT_STAGE" "otelcol extract"
            fi
          fi

          if [ "$(get_flag db_images)" = "true" ]; then
            docker pull postgres:16 || record_fail DOCKER_DAEMON "$CURRENT_STAGE" "pull postgres"
            docker pull mysql:8 || record_fail DOCKER_DAEMON "$CURRENT_STAGE" "pull mysql"
            docker pull redis:7 || record_fail DOCKER_DAEMON "$CURRENT_STAGE" "pull redis"
            docker pull mongo:7 || record_fail DOCKER_DAEMON "$CURRENT_STAGE" "pull mongo"
            docker pull bitnami/kafka:latest || docker pull redpandadata/redpanda:latest || record_fail DOCKER_DAEMON "$CURRENT_STAGE" "pull kafka/redpanda"
            docker pull minio/minio:latest || true
            docker pull minio/mc:latest || true
            docker pull hashicorp/vault:1.16 || true
          fi

          if [ "$(get_flag db_clis)" = "true" ]; then
            sudo apt-get install -y postgresql-client mysql-client redis-tools unzip || record_fail APT_LOCK "$CURRENT_STAGE" "db clis"
            dl https://dl.min.io/client/mc/release/linux-amd64/mc /tmp/mc && sudo install -m 0755 /tmp/mc /usr/local/bin/mc || record_fail DL_FAIL "$CURRENT_STAGE" "mc"
            dl https://releases.hashicorp.com/vault/1.16.3/vault_1.16.3_linux_amd64.zip /tmp/vault.zip || record_fail DL_FAIL "$CURRENT_STAGE" "vault zip"
            unzip -o /tmp/vault.zip -d /usr/local/bin && sudo chmod +x /usr/local/bin/vault || record_fail DOCKER_BUILD "$CURRENT_STAGE" "vault install"
            dl https://fastdl.mongodb.org/tools/db/mongodb-database-tools-ubuntu2204-x86_64-100.9.4.deb /tmp/mdb.deb || record_fail DL_FAIL "$CURRENT_STAGE" "mongodb tools"
            sudo dpkg -i /tmp/mdb.deb || warn "mongodb tools dpkg warning"
          fi

          if [ "$(get_flag build_runtimes)" = "true" ]; then
            curl -s "https://get.sdkman.io" | bash || warn "sdkman bootstrap failed"
            export SDKMAN_DIR="$HOME/.sdkman"
            set +u; [ -s "$SDKMAN_DIR/bin/sdkman-init.sh" ] && source "$SDKMAN_DIR/bin/sdkman-init.sh"; set -u
            sudo apt-get install -y python3-pip || record_fail APT_LOCK "$CURRENT_STAGE" "python3-pip"
            pip3 install --upgrade pip pipx poetry || warn "pipx/poetry upgrade fail"
            curl -fsSL https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash || warn "nvm install fail"
            export NVM_DIR="$HOME/.nvm"; set +u; [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"; set -u
            nvm install --lts || warn "nvm lts install fail"
            corepack enable || true
            npm i -g pnpm || warn "pnpm install fail"
          fi

          if [ "$(get_flag release_utils)" = "true" ]; then
            sudo apt-get install -y rclone || record_fail APT_LOCK "$CURRENT_STAGE" "rclone"
          fi

          if [ "$(get_flag docs_tools)" = "true" ]; then
            sudo apt-get install -y pandoc graphviz default-jre wkhtmltopdf || record_fail APT_LOCK "$CURRENT_STAGE" "docs tools"
            dl https://sourceforge.net/projects/plantuml/files/plantuml.jar/download /usr/local/bin/plantuml.jar || warn "plantuml download failed"
          fi

          note "[extras] completed ok"

      # ===== Help summary for setup_base =====
      - name: ğŸ†˜ Help Manual (always)
        if: always()
        run: |
          source /tmp/echo_helpers.sh
          show_help_summary

  build_matrix:
    needs: setup_base
    runs-on: ubuntu-latest
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        java: ['17','21']
    env:
      BOOT_ARTIFACT: ${{ needs.setup_base.outputs.artifact }}
      BOOT_DEPS: ${{ needs.setup_base.outputs.deps }}
      BASE_PORT: ${{ needs.setup_base.outputs.base_port }}
      BOOT_GROUP: com.example

    steps:
      - name: ğŸ›’ Checkout
        uses: actions/checkout@v4

      - name: â˜• Setup Java (no cache yet)
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: ${{ matrix.java }}

      - name: ğŸ“¦ Install Maven (tarball if version set)
        run: |
          source /tmp/echo_helpers.sh
          CURRENT_STAGE="maven-install"
          VER="${{ inputs.maven_version }}"
          if [ -n "$VER" ]; then
            URL="https://archive.apache.org/dist/maven/maven-3/${VER}/binaries/apache-maven-${VER}-bin.tar.gz"
            TMPD="$(mktemp -d)" || true
            (cd "$TMPD" && curl -fsSL "$URL" -o maven.tgz && tar -xzf maven.tgz) || record_fail DL_FAIL "$CURRENT_STAGE" "maven tarball"
            sudo rm -rf /opt/maven || true; sudo mv "$TMPD/apache-maven-${VER}" /opt/maven || record_fail DOCKER_BUILD "$CURRENT_STAGE" "move /opt/maven"
            echo "/opt/maven/bin" >> "$GITHUB_PATH"
            rm -rf "$TMPD" || true
          else
            sudo apt-get update -y || record_fail APT_LOCK "$CURRENT_STAGE" "apt update"
            sudo apt-get install -y maven unzip pigz || record_fail APT_LOCK "$CURRENT_STAGE" "apt install maven"
          fi
          mvn -v || record_fail MVN_BUILD "$CURRENT_STAGE" "mvn -v"

      - name: ğŸ§ª Generate Maven sample + patch (JDK=${{ matrix.java }})
        run: |
          source /tmp/echo_helpers.sh
          CURRENT_STAGE="maven-sample"
          mvn -q -T 1C archetype:generate -DgroupId=com.example -DartifactId=maven-sample -DarchetypeArtifactId=maven-archetype-quickstart -DarchetypeVersion=1.4 -DinteractiveMode=false || record_fail MVN_BUILD "$CURRENT_STAGE" "archetype"
          sed -i "s/__REL__/${{ matrix.java }}/g" maven-sample/pom.xml || true
          (cd maven-sample && mvn -q -T 1C -DskipTests package) || record_fail MVN_BUILD "$CURRENT_STAGE" "package"
          ls -al maven-sample/target || true

      - name: ğŸŒ± Generate Boot (Maven) + Hello + IT stub
        run: |
          source /tmp/echo_helpers.sh
          CURRENT_STAGE="boot-generate-maven"
          G="${{ env.BOOT_GROUP }}"; A="${{ env.BOOT_ARTIFACT }}"; D="${{ env.BOOT_DEPS }}"; J="${{ matrix.java }}"
          PKG="${G}.${A//-/.}"
          mkdir -p boot-app || true
          curl -fsSL -G https://start.spring.io/starter.zip \
            --data-urlencode "type=maven-project" \
            --data-urlencode "language=java" \
            --data-urlencode "groupId=$G" \
            --data-urlencode "artifactId=$A" \
            --data-urlencode "name=$A" \
            --data-urlencode "packageName=$PKG" \
            --data-urlencode "dependencies=$D" \
            --data-urlencode "javaVersion=$J" \
            --data-urlencode "packaging=jar" \
            -o boot-app.zip || record_fail START_SPRING "$CURRENT_STAGE" "download starter.zip"
          unzip -q -o boot-app.zip -d boot-app || record_fail START_SPRING "$CURRENT_STAGE" "unzip starter"
          # ì†ŒìŠ¤/í…ŒìŠ¤íŠ¸ ì¶”ê°€ëŠ” ë™ì¼ (ìƒëµ)
          echo "server.port=8080" >> boot-app/src/main/resources/application.properties || true

      - name: â˜• Enable Maven cache
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: ${{ matrix.java }}
          cache: maven

      - name: ğŸ—ï¸ Build Boot (Maven)
        working-directory: boot-app
        run: |
          source /tmp/echo_helpers.sh
          CURRENT_STAGE="boot-build-maven"
          if [ -x "./mvnw" ]; then ./mvnw -q -T 1C -DskipTests package || record_fail MVN_BUILD "$CURRENT_STAGE" "mvnw package"
          else mvn -q -T 1C -DskipTests package || record_fail MVN_BUILD "$CURRENT_STAGE" "mvn package"
          fi
          ls -al target || true

      - name: ğŸŒ± Generate Boot (Gradle)
        run: |
          source /tmp/echo_helpers.sh
          CURRENT_STAGE="boot-generate-gradle"
          # (ìƒì„± ë¡œì§ ë™ì¼) ì‹¤íŒ¨ ì‹œ:
          true

      - name: ğŸ—ï¸ Build Boot (Gradle)
        working-directory: boot-app-gradle
        run: |
          source /tmp/echo_helpers.sh
          CURRENT_STAGE="boot-build-gradle"
          chmod +x ./gradlew || true
          ./gradlew -q -Dorg.gradle.jvmargs="-Xmx1g" -x test build || record_fail GRADLE_BUILD "$CURRENT_STAGE" "gradle build"
          ls -al build/libs || true

      - name: ğŸ³ Setup QEMU/Buildx
        uses: docker/setup-qemu-action@v3
        with:
          platforms: all
      - uses: docker/setup-buildx-action@v3
        with:
          install: true

      - name: ğŸ³ Create Dockerfile (multi-stage, JDK=${{ matrix.java }})
        working-directory: boot-app
        run: |
          source /tmp/echo_helpers.sh
          CURRENT_STAGE="dockerfile"
          J="${{ matrix.java }}"
          BUILDER="maven:3.9.9-eclipse-temurin-${J}"
          RUNTIME="eclipse-temurin:${J}-jre"
          cat > Dockerfile <<EOF
          FROM ${BUILDER} AS builder
          WORKDIR /workspace
          COPY pom.xml .
          COPY src ./src
          RUN --mount=type=cache,target=/root/.m2 mvn -q -DskipTests package
          FROM ${RUNTIME}
          WORKDIR /app
          COPY --from=builder /workspace/target/*.jar /app/app.jar
          EXPOSE 8080
          USER 1000
          ENTRYPOINT ["java","-jar","/app/app.jar"]
          EOF
          printf "target/\n.git/\n.github/\n**/*.iml\n**/.DS_Store\n*.log\n" > .dockerignore || true

      - name: ğŸ³ Build image (cached) - tag by JDK
        id: docker_build
        working-directory: boot-app
        env:
          IMG: ${{ env.BOOT_ARTIFACT }}:local-j${{ matrix.java }}
        run: |
          source /tmp/echo_helpers.sh
          CURRENT_STAGE="docker-build"
          mkdir -p /tmp/.buildx-cache-${{ matrix.java }} /tmp/.buildx-cache-new-${{ matrix.java }} || true
          docker buildx build --load -t "${IMG}" \
            --cache-from type=local,src=/tmp/.buildx-cache-${{ matrix.java }} \
            --cache-to   type=local,dest=/tmp/.buildx-cache-new-${{ matrix.java }},mode=max \
            . || record_fail DOCKER_BUILD "$CURRENT_STAGE" "buildx"
          rm -rf /tmp/.buildx-cache-${{ matrix.java }} || true
          mv /tmp/.buildx-cache-new-${{ matrix.java }} /tmp/.buildx-cache-${{ matrix.java }} || true
          echo "image=${IMG}" >> "$GITHUB_OUTPUT" || true
          docker images | head -n 20 || true

      - name: ğŸ³ Save image tar
        working-directory: ${{ github.workspace }}
        env:
          IMG: ${{ steps.docker_build.outputs.image }}
        run: |
          source /tmp/echo_helpers.sh
          CURRENT_STAGE="docker-save"
          docker save "${IMG}" -o "artifacts/${IMG/:/_}.tar" 2>/dev/null || record_fail DOCKER_BUILD "$CURRENT_STAGE" "docker save"

      - name: ğŸ³ Run container (No-Stop)
        id: docker_run
        env:
          IMG: ${{ steps.docker_build.outputs.image }}
          BASE: ${{ env.BASE_PORT }}
          J: ${{ matrix.java }}
        run: |
          source /tmp/echo_helpers.sh
          CURRENT_STAGE="docker-run"
          PORT=$BASE; [ "$J" = "21" ] && PORT=$((BASE+1))
          NAME="boot-app-${J}-${GITHUB_RUN_ID}"
          docker run -d --name "${NAME}" -p "${PORT}:8080" "${IMG}" || record_fail DOCKER_DAEMON "$CURRENT_STAGE" "docker run"
          echo "container_name=${NAME}" >> "$GITHUB_OUTPUT"
          echo "PORT=${PORT}" >> "$GITHUB_OUTPUT"
          for i in $(seq 1 30); do
            sleep 2
            if (curl -fsS "http://localhost:${PORT}/actuator/health" || curl -fsS "http://localhost:${PORT}/hello"); then
              break
            fi
            echo "[echo] waiting app(${J})... ($i)"
            [ "$i" -eq 30 ] && record_fail CONTAINER_HEALTH "$CURRENT_STAGE" "no response on ${PORT}"
          done
          docker logs --tail 120 "${NAME}" 2>/dev/null || true

      - name: â¬†ï¸ Upload artifacts (per JDK)
        uses: actions/upload-artifact@v4
        with:
          name: bundles-j${{ matrix.java }}
            # 0ë°”ì´íŠ¸ ì œì™¸ëŠ” ì—…ë¡œë“œ ë‹¨ê³„ì—ì„œ ì²˜ë¦¬ë¨(ì•„ë˜ release job)
          path: |
            artifacts/*
            maven-sample/target/*.jar
            boot-app/target/*.jar
            boot-app/Dockerfile
            boot-app/.dockerignore
            boot-app-gradle/build/libs/*.jar
          if-no-files-found: warn
          retention-days: 7

      - name: ğŸ†˜ Help Manual (always)
        if: always()
        run: |
          source /tmp/echo_helpers.sh
          show_help_summary

  release:
    needs: [setup_base, build_matrix]
    runs-on: ubuntu-latest
    continue-on-error: false
    steps:
      - name: â¬‡ï¸ Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: release_artifacts

      - name: ğŸ§¾ List artifacts
        run: |
          source /tmp/echo_helpers.sh
          find release_artifacts -type f -printf "%p (%s bytes)\n" || true

      - name: ğŸ§° Normalize & de-duplicate â†’ release-bundle/
        run: |
          source /tmp/echo_helpers.sh
          CURRENT_STAGE="bundle"
          set -Eeuo pipefail
          mkdir -p release-bundle
          declare -A seen=()
          while IFS= read -r -d '' f; do
            base="$(basename "$f")"; ext="${base##*.}"; stem="${base%.*}"; sfx=""
            case "$f" in *bundles-j17/*) sfx="${sfx:+$sfx-}j17";; *bundles-j21/*) sfx="${sfx:+$sfx-}j21";; esac
            case "$f" in */boot-app-gradle/*|*gradle/*) sfx="${sfx:+$sfx-}gradle";; */boot-app/*|*maven-sample/*) sfx="${sfx:+$sfx-}maven";; esac
            out="${base}"; [ -n "$sfx" ] && out="${stem}-${sfx}.${ext}"
            key="$out"
            if [[ -n "${seen[$key]:-}" ]]; then cnt="${seen[$key]}"; seen["$key"]=$((cnt+1)); out="${stem}-${sfx:+$sfx-}dup$((cnt+1)).${ext}"; else seen["$key"]=1; fi
            cp -f "$f" "release-bundle/$out" || record_fail GH_UPLOAD_0B "$CURRENT_STAGE" "copy $f"
          done < <(find release_artifacts -type f -print0)
          (cd release-bundle && ls -al) || true

      - name: ğŸš€ Create/Update Release with GH CLI (skip 0B, per-file upload)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          source /tmp/echo_helpers.sh
          CURRENT_STAGE="release"
          set -Eeuo pipefail
          TAG="auto-${{ github.run_number }}"
          TITLE="Auto Release #${{ github.run_number }}"
          REPO="${{ github.repository }}"
          if ! gh release view "$TAG" --repo "$REPO" >/dev/null 2>&1; then
            if [ "${{ inputs.release_prerelease }}" = "true" ]; then
              gh release create "$TAG" --title "$TITLE" --notes "" --prerelease --repo "$REPO" || record_fail GH_AUTH "$CURRENT_STAGE" "create prerelease"
            else
              gh release create "$TAG" --title "$TITLE" --notes "" --repo "$REPO" || record_fail GH_AUTH "$CURRENT_STAGE" "create release"
            fi
          fi
          mapfile -d '' FILES < <(find release-bundle -type f -size +0c -print0)
          if [ "${#FILES[@]}" -eq 0 ]; then
            record_fail GH_UPLOAD_0B "$CURRENT_STAGE" "no non-empty files"
          fi
          for f in "${FILES[@]}"; do
            for n in 1 2 3; do
              if gh release upload "$TAG" "$f" --clobber --repo "$REPO"; then
                echo "uploaded: $f"; break
              else
                warn "upload failed ($n/3) for $f; retrying..."
                sleep 2
                [ "$n" -eq 3 ] && record_fail GH_AUTH "$CURRENT_STAGE" "upload $f"
              fi
            done
          done

      - name: ğŸ†˜ Help Manual (always)
        if: always()
        run: |
          source /tmp/echo_helpers.sh
          show_help_summary

  promote_to_prod:
    needs: [setup_base, build_matrix]
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: â¬‡ï¸ Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: stage_artifacts

      - name: ğŸ“¦ Promote artifacts â†’ prod (rename/retag tar)
        run: |
          source /tmp/echo_helpers.sh
          CURRENT_STAGE="promote"
          mkdir -p prod_artifacts
          find stage_artifacts -type f -name "*.tar" -print0 | while IFS= read -r -d '' f; do
            base="$(basename "$f")"; prod="${base/local/prod}"
            cp -f "$f" "prod_artifacts/${prod}" || record_fail GH_UPLOAD_0B "$CURRENT_STAGE" "copy tar"
          done
          find stage_artifacts -type f \( -name "*.jar" -o -name "*.tgz" \) -print0 | while IFS= read -r -d '' f; do
            cp -f "$f" "prod_artifacts/$(basename "$f")" || record_fail GH_UPLOAD_0B "$CURRENT_STAGE" "copy pkg"
          done
          ls -al prod_artifacts || true

      - name: â¬†ï¸ Upload prod bundle
        uses: actions/upload-artifact@v4
        with:
          name: prod-bundles
          path: prod_artifacts/*
          if-no-files-found: warn
          retention-days: 14

      - name: ğŸ›’ Checkout (for PR)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: ğŸ“ Create a PROD workflow copy (PR)
        run: |
          source /tmp/echo_helpers.sh
          CURRENT_STAGE="prod-pr"
          mkdir -p .github/workflows
          cat > .github/workflows/test1-prod.yml <<'YML'
          name: PROD Runner (wrapper)
          on:
            workflow_dispatch:
          jobs:
            info:
              runs-on: ubuntu-latest
              steps:
                - run: echo "This is a placeholder PROD workflow. It exists as a copy for ops traceability."
          YML

      - name: ğŸ” Open PR for PROD workflow copy (hardened)
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(prod): add prod workflow copy & promote bundles"
          title: "chore(prod): add prod workflow copy & promote bundles"
          body: |
            ìë™ ìƒì„±ëœ PROD ì›Œí¬í”Œë¡œìš° ë˜í¼ ë° í”„ë¡œëª¨ì…˜ ë²ˆë“¤ ì—…ë¡œë“œ.
            - test1-prod.yml ì¶”ê°€(ìš´ì˜ ì¶”ì ìš©)
            - ì•„í‹°íŒ©íŠ¸(prod-bundles) í¬í•¨
          branch: promote/prod-${{ github.run_id }}
          delete-branch: true
          author: "github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>"
          committer: "github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>"

      - name: ğŸ†˜ Help Manual (always)
        if: always()
        run: |
          source /tmp/echo_helpers.sh
          show_help_summary
