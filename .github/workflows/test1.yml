name: Setup SpringBoot & Maven (Fast Disk + Upgrades + Test-Mode + JDK Fix)

on:
  workflow_dispatch:
    inputs:
      freedisk_profile:
        description: "FreeDisk í”„ë¡œíŒŒì¼ (none|minimal/aggressive)"
        required: true
        default: "minimal"
      lowdisk_mode:
        description: "ì €ìš©ëŸ‰ ë””ìŠ¤í¬ ì‹œë®¬ (off|tmpfs|loop)"
        required: true
        default: "tmpfs"
      fast_compress:
        description: "pigz ë³‘ë ¬ ì••ì¶• ì‚¬ìš© (true/false)"
        required: true
        default: "true"
      upgrade_os:
        description: "OS íŒ¨í‚¤ì§€ ì—…ê·¸ë ˆì´ë“œ ì‹¤í–‰ (true/false)"
        required: true
        default: "false"
      java_version:
        description: "ì„¤ì¹˜/ì‚¬ìš©í•  JDK ë²„ì „ (ì˜ˆ: 17, 21)"
        required: false
        default: "17"
      maven_version:
        description: "ì„¤ì¹˜í•  Maven ë²„ì „ (ì˜ˆ: 3.9.9). ë¹„ìš°ë©´ apt ê¸°ë³¸ ì‚¬ìš©"
        required: false
        default: ""
      purge_apt_cache:
        description: "Apt ìºì‹œ/ë¡œê·¸ ì •ë¦¬ (true/false)"
        required: true
        default: "false"

permissions:
  contents: write

jobs:
  setup:
    runs-on: ubuntu-latest
    continue-on-error: true  # í…ŒìŠ¤íŠ¸ ì„œë²„ ëª¨ë“œ: ì‹¤íŒ¨í•´ë„ ì§„í–‰

    steps:
      - name: ğŸ›’ Checkout
        uses: actions/checkout@v4
        continue-on-error: true

      - name: ğŸ“Š Show initial df/ip
        run: |
          set -o pipefail
          echo "== df -h ==" && df -h || true
          echo "== ip a (head) ==" && ip a || true
        continue-on-error: true

      - name: ğŸ§¹ Free up disk space (profiled)
        uses: jlumbroso/free-disk-space@main
        with:
          android:        ${{ github.event.inputs.freedisk_profile == 'aggressive' }}
          dotnet:         ${{ github.event.inputs.freedisk_profile == 'aggressive' }}
          haskell:        ${{ github.event.inputs.freedisk_profile == 'aggressive' }}
          large-packages: ${{ github.event.inputs.freedisk_profile == 'aggressive' }}
          docker-images:  ${{ github.event.inputs.freedisk_profile == 'minimal' || github.event.inputs.freedisk_profile == 'aggressive' }}
          tool-cache:     ${{ github.event.inputs.freedisk_profile == 'minimal' || github.event.inputs.freedisk_profile == 'aggressive' }}
          swap-storage:   ${{ github.event.inputs.freedisk_profile == 'aggressive' }}
        continue-on-error: true

      - name: ğŸ“Š df after cleanup
        run: df -h || true
        continue-on-error: true

      - name: â¬†ï¸ Upgrade OS packages (safe)
        if: ${{ github.event.inputs.upgrade_os == 'true' }}
        run: |
          set -o pipefail
          sudo apt-get update -y || true
          sudo DEBIAN_FRONTEND=noninteractive apt-get -y upgrade || true
          sudo dpkg --configure -a || true
          sudo apt-get -f install || true
          df -h || true
        continue-on-error: true

      - name: ğŸ§¯ Purge apt cache & logs
        if: ${{ github.event.inputs.purge_apt_cache == 'true' }}
        run: |
          set -o pipefail
          sudo apt-get clean || true
          sudo rm -rf /var/lib/apt/lists/* || true
          sudo journalctl --vacuum-time=1s || true
          sudo find /var/log -type f -name "*.gz" -delete || true
          sudo find /var/log -type f -name "*.1" -delete || true
          df -h || true
        continue-on-error: true

      - name: âš¡ Low-disk simulate (tmpfs/loop/off)
        id: lowdisk
        run: |
          set -o pipefail
          MODE="${{ github.event.inputs.lowdisk_mode }}"
          echo "lowdisk_mode=$MODE"
          if [ -z "$MODE" ] || [ "$MODE" = "off" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          if [ "$MODE" = "tmpfs" ]; then
            AVAIL_KB=$(awk '/MemAvailable/ {print $2}' /proc/meminfo 2>/dev/null || echo 0)
            SIZE_G=2; if [ "$AVAIL_KB" -gt $((8*1024*1024)) ]; then SIZE_G=4; fi
            MNT="/mnt/lowdisk"; sudo mkdir -p "$MNT" || true
            sudo mount -t tmpfs -o size=${SIZE_G}G,noatime,nodev,nosuid tmpfs "$MNT" || true
            sudo chmod 777 "$MNT" || true
            echo "mode=tmpfs" >> $GITHUB_OUTPUT
            echo "mnt=$MNT"  >> $GITHUB_OUTPUT
            df -h "$MNT" || true
            exit 0
          fi
          if [ "$MODE" = "loop" ]; then
            MNT="/mnt/lowdisk"; IMG="/mnt/tmp-pv.img"
            sudo mkdir -p "$MNT" || true
            AVAIL_GB=$(df --output=avail -BG /mnt | tail -1 | tr -dc '0-9' || echo 0)
            SIZE_GB=2; if [ "$AVAIL_GB" -ge 12 ]; then SIZE_GB=4; fi
            echo "Creating ${SIZE_GB}G loop image at $IMG (Avail=${AVAIL_GB}G)"
            sudo fallocate -l ${SIZE_GB}G "$IMG" 2>/dev/null || sudo truncate -s ${SIZE_GB}G "$IMG" || true
            sudo mkfs.ext4 -F -E lazy_itable_init=1,lazy_journal_init=1 -O ^has_journal "$IMG" || true
            sudo mount -o loop,noatime,nodiratime "$IMG" "$MNT" || true
            sudo chmod 777 "$MNT" || true
            echo "mode=loop" >> $GITHUB_OUTPUT
            echo "mnt=$MNT"  >> $GITHUB_OUTPUT
            echo "img=$IMG"  >> $GITHUB_OUTPUT
            df -h "$MNT" || true
            exit 0
          fi
          echo "skip=true" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: ğŸ§± Prepare dirs (workspace + /opt demo)
        run: |
          set -o pipefail
          mkdir -p "$GITHUB_WORKSPACE/artifacts" || true
          sudo mkdir -p /opt/project/springboot/{src,logs,temp,server} || true
          sudo mkdir -p /opt/project/maven/{src,target,logs} || true
          echo "Simulated Spring Boot JAR" | sudo tee /opt/project/springboot/server/app.jar >/dev/null || true
          echo "Spring Boot Server Log"   | sudo tee /opt/project/springboot/logs/server.log >/dev/null || true
          echo "Maven Placeholder"        | sudo tee /opt/project/maven/src/Main.java >/dev/null || true
        continue-on-error: true

      - name: â˜• Set up Java (no cache yet)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ inputs.java_version }}
        continue-on-error: true

      - name: ğŸ“¦ Install Maven (tarball if version set)
        run: |
          set -o pipefail
          VER="${{ github.event.inputs.maven_version }}"
          if [ -n "$VER" ]; then
            echo "Installing Apache Maven $VER (tarball)"
            URL="https://archive.apache.org/dist/maven/maven-3/${VER}/binaries/apache-maven-${VER}-bin.tar.gz"
            TMPD="$(mktemp -d)" || true
            (cd "$TMPD" && curl -fsSL "$URL" -o maven.tgz && tar -xzf maven.tgz) || true
            sudo rm -rf /opt/maven || true
            sudo mv "$TMPD/apache-maven-${VER}" /opt/maven || true
            echo "/opt/maven/bin" >> "$GITHUB_PATH"
            rm -rf "$TMPD" || true
          else
            echo "Installing Maven from apt"
            sudo apt-get update -y || true
            sudo apt-get install -y maven pigz || true
          fi
          mvn -v || true
        continue-on-error: true

      - name: ğŸ§ª Generate Maven sample (IN WORKSPACE)
        working-directory: ${{ github.workspace }}
        run: |
          set -o pipefail
          # ìµœì‹  ì•„í‚¤íƒ€ì… ë²„ì „ ì§€ì •(í˜¸í™˜ì„± í–¥ìƒ)
          mvn -q archetype:generate \
            -DgroupId=com.example \
            -DartifactId=maven-sample \
            -DarchetypeArtifactId=maven-archetype-quickstart \
            -DarchetypeVersion=1.4 \
            -DinteractiveMode=false || true
          test -f "$GITHUB_WORKSPACE/maven-sample/pom.xml" || echo "âš ï¸ pom.xml ìƒì„± í™•ì¸ í•„ìš”" || true
        continue-on-error: true

      # âœ… JDK 17/21ì—ì„œë„ ì»´íŒŒì¼ë˜ë„ë¡ POM íŒ¨ì¹˜ (compiler plugin + <release>)
      - name: ğŸ©¹ Patch POM for modern JDK (set compiler release)
        working-directory: ${{ github.workspace }}/maven-sample
        run: |
          set -o pipefail
          JVER="${{ github.event.inputs.java_version }}"
          case "$JVER" in
            ""|"11"|"17"|"21") : ;; # í—ˆìš©
            *) JVER="17" ;;
          esac
          echo "Using Java release=$JVER for compilation"
          # ê¸°ì¡´ POMì„ í˜„ëŒ€í™”ëœ ì„¤ì •ìœ¼ë¡œ êµì²´(ì†ŒìŠ¤ ë””ë ‰í† ë¦¬ëŠ” ìœ ì§€)
          cat > pom.xml <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <project xmlns="http://maven.apache.org/POM/4.0.0"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
            <modelVersion>4.0.0</modelVersion>
            <groupId>com.example</groupId>
            <artifactId>maven-sample</artifactId>
            <version>1.0.0</version>
            <name>maven-sample</name>
            <properties>
              <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
              <maven.compiler.release>${JVER}</maven.compiler.release>
            </properties>
            <build>
              <plugins>
                <plugin>
                  <groupId>org.apache.maven.plugins</groupId>
                  <artifactId>maven-compiler-plugin</artifactId>
                  <version>3.11.0</version>
                  <configuration>
                    <release>\${maven.compiler.release}</release>
                  </configuration>
                </plugin>
                <plugin>
                  <groupId>org.apache.maven.plugins</groupId>
                  <artifactId>maven-surefire-plugin</artifactId>
                  <version>3.2.5</version>
                </plugin>
              </plugins>
            </build>
            <dependencies>
              <!-- JUnit 4 (ì•„í‚¤íƒ€ì… 1.4 ì†ŒìŠ¤ì™€ í˜¸í™˜) -->
              <dependency>
                <groupId>junit</groupId>
                <artifactId>junit</artifactId>
                <version>4.13.2</version>
                <scope>test</scope>
              </dependency>
            </dependencies>
          </project>
          EOF
          echo "Patched POM with maven-compiler-plugin (release=${JVER})"
        continue-on-error: true

      - name: â˜• Enable Maven cache (setup-java)
        if: ${{ hashFiles('maven-sample/pom.xml') != '' }}
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ inputs.java_version }}
          cache: 'maven'
          cache-dependency-path: |
            maven-sample/pom.xml
        continue-on-error: true

      - name: ğŸ—ï¸ Build (maven-sample)
        working-directory: ${{ github.workspace }}/maven-sample
        run: |
          set -o pipefail
          mvn -q -DskipTests package || true
          ls -al target || true
        continue-on-error: true

      - name: ğŸ“¦ Archive (fast) & Upload Artifacts
        run: |
          set -o pipefail
          mkdir -p "$GITHUB_WORKSPACE/artifacts" || true
          cp -f "$GITHUB_WORKSPACE/maven-sample/target/"*.jar "$GITHUB_WORKSPACE/artifacts/" 2>/dev/null || true
          if [ "${{ github.event.inputs.fast_compress }}" = "true" ]; then
            tar --use-compress-program=pigz -cf "$GITHUB_WORKSPACE/artifacts/maven-sample.tgz" -C "$GITHUB_WORKSPACE" maven-sample 2>/dev/null || true
          else
            tar -czf "$GITHUB_WORKSPACE/artifacts/maven-sample.tgz" -C "$GITHUB_WORKSPACE" maven-sample 2>/dev/null || true
          fi
        continue-on-error: true

      - name: â¬†ï¸ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: maven-sample-build
          path: artifacts/*
          if-no-files-found: warn
          retention-days: 7
        continue-on-error: true

      - name: ğŸ“„ Summary
        run: |
          set -o pipefail
          echo "ğŸ“„ DONE (Fast Disk + Upgrades + Test-Mode + JDK Fix)"
          echo "- freedisk_profile: ${{ github.event.inputs.freedisk_profile }}"
          echo "- lowdisk_mode: ${{ github.event.inputs.lowdisk_mode }}"
          echo "- java_version: ${{ github.event.inputs.java_version }}"
          echo "- maven_version: ${{ github.event.inputs.maven_version || 'apt-default' }}"
          if [ -n "${{ steps.lowdisk.outputs.mnt }}" ]; then
            echo "- lowdisk mount: ${{ steps.lowdisk.outputs.mnt }} (mode=${{ steps.lowdisk.outputs.mode }})"
          fi
          echo "== df -h ==" && df -h || true
        continue-on-error: true

      - name: ğŸ§½ Post-cleanup (unmount & remove loopback/tmpfs)
        if: always()
        run: |
          set -o pipefail
          MODE="${{ steps.lowdisk.outputs.mode }}"
          if [ "$MODE" = "tmpfs" ] && [ -n "${{ steps.lowdisk.outputs.mnt }}" ]; then
            sudo umount "${{ steps.lowdisk.outputs.mnt }}" || true
          fi
          if [ "$MODE" = "loop" ]; then
            if [ -n "${{ steps.lowdisk.outputs.mnt }}" ] && mountpoint -q "${{ steps.lowdisk.outputs.mnt }}"; then
              sudo umount "${{ steps.lowdisk.outputs.mnt }}" || true
            fi
            if [ -n "${{ steps.lowdisk.outputs.img }}" ] && [ -f "${{ steps.lowdisk.outputs.img }}" ]; then
              sudo rm -f "${{ steps.lowdisk.outputs.img }}" || true
            fi
          fi
          echo "Cleanup done."
        continue-on-error: true
