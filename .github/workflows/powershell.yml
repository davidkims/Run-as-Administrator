name: PSScriptAnalyzer

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '37 9 * * 3'

permissions:
  contents: read

jobs:
  analyze-powershell:
    name: Run PSScriptAnalyzer and upload SARIF
    runs-on: ubuntu-latest

    permissions:
      contents: read
      security-events: write
      actions: read

    steps:
      - name: 📥 Checkout source code
        uses: actions/checkout@v4

      - name: 🧪 Run PSScriptAnalyzer
        uses: microsoft/psscriptanalyzer-action@6b2948b1944407914a58661c49941824d149734f
        with:
          path: ./
          recurse: true
          includeRule: '["PSAvoidGlobalAliases", "PSAvoidUsingConvertToSecureStringWithPlainText"]'
          output: results.sarif

      - name: 📤 Upload SARIF results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results.sarif

      - name: 🧾 Show findings summary
        if: success()
        run: |
          echo "✅ Static analysis complete."
          if [ -f results.sarif ]; then
            echo "🔍 Results file located at results.sarif"
            echo "📊 Use GitHub Security tab to review detected PowerShell code issues."
          else
            echo "⚠️ No SARIF file found. PSScriptAnalyzer might have failed or found no issues."
          fi
