name: PSScriptAnalyzer with Auto-Generated Settings

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '37 9 * * 3'

permissions:
  contents: read

jobs:
  analyze-powershell:
    name: Analyze PowerShell Code
    runs-on: ubuntu-latest

    permissions:
      contents: read
      security-events: write
      actions: read

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ›  Generate .psd1 configuration file
        run: |
          mkdir -p .github
          cat << 'EOF' > .github/psscriptanalyzer-settings.psd1
@{
    IncludeRules = @(
        'PSAvoidGlobalAliases',
        'PSAvoidUsingConvertToSecureStringWithPlainText',
        'PSAvoidUsingWriteHost'
    )
    Rules = @{
        PSAvoidUsingWriteHost = @{
            Severity = 'Warning'
        }
    }
}
EOF

      - name: ðŸ§ª Run PSScriptAnalyzer
        uses: microsoft/psscriptanalyzer-action@6b2948b1944407914a58661c49941824d149734f
        with:
          path: ./
          recurse: true
          settingsPath: .github/psscriptanalyzer-settings.psd1
          output: results.sarif

      - name: ðŸ“¤ Upload SARIF results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results.sarif
