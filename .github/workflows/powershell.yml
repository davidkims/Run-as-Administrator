name: PowerShell SARIF Analysis

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

permissions:
  contents: write
  pages: write
  id-token: write
  security-events: write

jobs:
  analyze:
    name: Run Full PSScriptAnalyzer and Upload SARIF
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      - name: üõ† Create Sample PowerShell Script
        run: |
          mkdir -p scripts
          echo 'Write-Host "Hello, world!"' > scripts/sample.ps1

      - name: üß™ Run PSScriptAnalyzer and Build SARIF
        shell: pwsh
        run: |
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser -AllowClobber
          $results = Invoke-ScriptAnalyzer -Path "./scripts" -Recurse -Severity Error,Warning,Information
          $sarif = @{
            '$schema' = 'https://json.schemastore.org/sarif-2.1.0.json'
            version = '2.1.0'
            runs = @(@{
              tool = @{
                driver = @{
                  name = 'PSScriptAnalyzer'
                  version = '1.24.0'
                }
              }
              results = @()
            })
          }
          foreach ($res in $results) {
            $sarif.runs[0].results += @{
              ruleId = $res.RuleName
              level = $res.Severity.ToLower()
              message = @{ text = $res.Message }
              locations = @(@{
                physicalLocation = @{
                  artifactLocation = @{ uri = $res.ScriptPath }
                  region = @{ startLine = $res.Line }
                }
              })
            }
          }
          $sarif | ConvertTo-Json -Depth 10 | Out-File results.sarif -Encoding utf8

      - name: üì§ Upload SARIF to GitHub Code Scanning
        id: sarif-upload
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results.sarif
        continue-on-error: true

      - name: ‚ö†Ô∏è Install SARIF Multitool
        if: steps.sarif-upload.outcome == 'failure'
        run: npm install -g @microsoft/sarif-multitool

      - name: üåê Generate HTML Report with Summary Table
        if: steps.sarif-upload.outcome == 'failure'
        run: |
          mkdir -p report
          sarif-multitool rewrite results.sarif -o report/results.sarif
          echo "<html><body><h1>Fallback SARIF Report</h1>" > report/index.html
          echo "<table border='1'><tr><th>Rule ID</th><th>Message</th><th>File</th><th>Line</th></tr>" >> report/index.html
          cat results.sarif | jq -r '.runs[].results[] | "<tr><td>" + .ruleId + "</td><td>" + .message.text + "</td><td>" + .locations[0].physicalLocation.artifactLocation.uri + "</td><td>" + (.locations[0].physicalLocation.region.startLine|tostring) + "</td></tr>"' >> report/index.html
          echo "</table><hr><pre>" >> report/index.html
          cat results.sarif >> report/index.html
          echo "</pre></body></html>" >> report/index.html

      - name: üöÄ Deploy to GitHub Pages (Fallback)
        if: steps.sarif-upload.outcome == 'failure'
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./report
